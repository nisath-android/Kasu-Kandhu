<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>காசு-கந்து PRO v9.6.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style id="dynamic-theme">
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Serif+Tamil:wght@400;700&display=swap');
        :root { --primary-color: #6366f1; --bg-color: #fcfdfe; --text-color: #1e293b; --card-radius: 28px; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: all 0.3s; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .theme-primary { background: linear-gradient(135deg, var(--primary-color) 0%, #4f46e5 100%); }
        .theme-card { background: white; border-radius: var(--card-radius); border: 1px solid #f1f5f9; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); }
        #splash { position: fixed; inset: 0; background: white; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .progress-bar { width: 240px; height: 8px; background: #f1f5f9; border-radius: 10px; overflow: hidden; margin-top: 30px; }
        .progress-fill { width: 0%; height: 100%; background: var(--primary-color); transition: 0.4s; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .cal-day { min-height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-weight: 600; }
        .emi-date { background: var(--primary-color) !important; color: white !important; box-shadow: 0 4px 10px rgba(99,102,241,0.3); }
        .syncing-active .dot { animation: pulse 1.5s infinite; opacity: 1; }
        @keyframes pulse { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(0.8); opacity: 0.5; } }
        #dashboard { display: none; }
        .screen { display: none; } .screen.active { display: block; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #e2e8f0; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(14px); }
        .otp-box { width: 45px; height: 55px; border-radius: 12px; background: #f8fafc; border: 2px solid #e2e8f0; text-align: center; font-size: 20px; font-weight: 800; outline: none; transition: 0.2s; }
        .otp-box:focus { border-color: var(--primary-color); background: white; box-shadow: 0 0 10px rgba(99,102,241,0.1); }
        .sub-pill { padding: 8px 16px; border-radius: 12px; font-size: 10px; font-weight: 700; background: #f8fafc; border: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .sub-pill.active { background: var(--primary-color); color: white; }
        .gw-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .disconnected { background: #f43f5e; box-shadow: 0 0 8px #f43f5e; animation: pulse-err 1s infinite; }
        @keyframes pulse-err { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body class="antialiased hide-scrollbar" onclick="resetInactivityTimer()" onkeypress="resetInactivityTimer()">

    <!-- Splash Screen -->
    <div id="splash">
        <h1 class="text-4xl font-black italic" style="color:var(--primary-color)">காசு-கந்து</h1>
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        <p id="progress-text" class="mt-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">தயார் செய்யப்படுகிறது... 0%</p>
    </div>

    <!-- Init View -->
    <div id="init-view" class="h-screen flex flex-col bg-slate-50 overflow-y-auto">
        <div class="flex-1 flex items-center justify-center p-6">
            <div id="auth-panel" class="w-full max-w-sm bg-white p-10 rounded-[3rem] shadow-xl text-center">
                
                <!-- Login -->
                <div id="auth-login" class="screen active">
                    <h2 class="text-3xl font-black mb-10 italic">உள்நுழைக</h2>
                    <input type="email" id="loginEmail" placeholder="மின்னஞ்சல்" class="w-full p-5 bg-slate-50 rounded-2xl mb-4 outline-none font-bold text-center shadow-inner">
                    <input type="password" id="loginPass" placeholder="கடவுச்சொல்" class="w-full p-5 bg-slate-50 rounded-2xl mb-6 outline-none font-bold text-center shadow-inner">
                    <button onclick="loginUser()" id="btn-login" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all">உள்நுழைக</button>
                    <div class="mt-8 space-y-4">
                        <button onclick="requestOTP()" class="text-[10px] font-bold text-indigo-500 uppercase underline">OTP மூலம் நுழைய</button>
                        <button onclick="toggleAuth('register')" class="text-[10px] font-bold text-slate-400 uppercase underline">புதிய கணக்கு தொடங்க</button>
                    </div>
                </div>

                <!-- OTP -->
                <div id="auth-otp" class="screen">
                    <h2 class="text-2xl font-black mb-2 italic">சரிபார்ப்பு</h2>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-8 leading-tight">மின்னஞ்சலுக்கு அனுப்பப்பட்ட குறியீட்டை இடவும்</p>
                    <div class="flex justify-between gap-1.5 mb-8">
                        <input type="text" maxlength="1" onpaste="handleOtpPaste(event)" onkeyup="moveNext(this, event)" class="otp-box shadow-sm">
                        <input type="text" maxlength="1" onkeyup="moveNext(this, event)" class="otp-box shadow-sm">
                        <input type="text" maxlength="1" onkeyup="moveNext(this, event)" class="otp-box shadow-sm">
                        <input type="text" maxlength="1" onkeyup="moveNext(this, event)" class="otp-box shadow-sm">
                        <input type="text" maxlength="1" onkeyup="moveNext(this, event)" class="otp-box shadow-sm">
                        <input type="text" maxlength="1" onkeyup="moveNext(this, event)" class="otp-box shadow-sm">
                    </div>
                    <p id="otpTimer" class="text-[10px] font-black text-rose-500 mb-6 uppercase">நேரம்: 60s</p>
                    <button onclick="verifyOTP()" id="btn-verify" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg">உறுதி செய்க</button>
                    <button onclick="toggleAuth('login')" class="mt-6 text-[10px] font-bold text-slate-300 uppercase underline">திரும்பச் செல்</button>
                </div>

                <!-- Register -->
                <div id="auth-register" class="screen">
                    <h2 class="text-3xl font-black mb-8 italic">பதிவு செய்க</h2>
                    <input type="text" id="regName" placeholder="பெயர்" class="w-full p-5 bg-slate-50 rounded-2xl mb-4 outline-none font-bold text-center shadow-inner">
                    <input type="email" id="regEmail" placeholder="மின்னஞ்சல்" class="w-full p-5 bg-slate-50 rounded-2xl mb-4 outline-none font-bold text-center shadow-inner">
                    <input type="password" id="regPass" placeholder="கடவுச்சொல்" class="w-full p-5 bg-slate-50 rounded-2xl mb-6 outline-none font-bold text-center shadow-inner">
                    <button onclick="registerAccount()" id="btn-reg" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg">பதிவு செய்</button>
                    <button onclick="toggleAuth('login')" class="mt-8 text-[10px] font-bold text-slate-400 uppercase underline">லாகின் செய்ய</button>
                </div>
            </div>
        </div>
        <div class="p-6 bg-white border-t">
            <div class="flex items-center justify-between mb-2 px-1">
                <span class="text-[9px] font-black text-slate-400 uppercase">Gateway Setup</span>
                <span id="gw-status-text" class="text-[8px] font-bold uppercase text-rose-500"><span id="gw-dot" class="gw-indicator disconnected"></span>இணைக்கப்படவில்லை</span>
            </div>
            <input type="text" id="gUrlInput" placeholder="URL-ஐ இங்கே இடவும்..." class="w-full p-4 text-[10px] border-none rounded-xl bg-slate-100 mb-2 outline-none shadow-inner font-mono">
            <button onclick="saveGateway()" id="btn-gw" class="w-full py-3 bg-slate-200 text-[10px] font-black rounded-xl uppercase transition-all">Gateway இணைக்கவும்</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="pb-32">
        <header class="bg-white border-b sticky top-0 z-[100] p-6 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-2xl overflow-hidden border-2 border-white shadow-md bg-slate-100" onclick="showProfileModal()">
                    <img id="userAvatar" src="" class="w-full h-full object-cover">
                </div>
                <div>
                    <h1 id="userNameUI" class="text-sm font-black italic">பயனர்</h1>
                    <div class="flex items-center gap-1.5 mt-1">
                        <div id="syncIndicator" class="w-1.5 h-1.5 rounded-full bg-indigo-500 opacity-0 dot"></div>
                        <span id="liveClock" class="text-[8px] font-bold text-slate-400 uppercase tracking-widest leading-none">00:00:00 AM</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-end">
                    <span id="autoLogoutTimerDisplay" class="text-[7px] font-black text-rose-500 uppercase tracking-tighter mb-1 leading-none">OFF</span>
                    <label class="switch"><input type="checkbox" id="autoLogoutToggle" onchange="handleLogoutToggle()"><span class="slider"></span></label>
                </div>
                <button onclick="logout()" class="w-10 h-10 bg-rose-50 text-rose-600 rounded-xl flex items-center justify-center shadow-sm active:scale-90 transition-transform"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <main class="p-5 space-y-6 max-w-md mx-auto">
            <!-- Rate Card -->
            <div class="theme-card p-6 border-none">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div><p class="text-[8px] font-black text-slate-400 uppercase mb-2">22K தங்கம்</p><p class="text-sm font-black text-emerald-600">₹<span id="rate22k">0</span></p></div>
                    <div class="border-x"><p class="text-[8px] font-black text-slate-400 uppercase mb-2">24K தங்கம்</p><p class="text-sm font-black text-slate-800">₹<span id="rate24k">0</span></p></div>
                    <div><p class="text-[8px] font-black text-slate-400 uppercase mb-2 text-blue-500">வெள்ளி</p><p class="text-sm font-black text-blue-600">₹<span id="rateSilver">0</span></p></div>
                </div>
                <div class="mt-4 pt-3 border-t flex justify-between items-center text-[7px] font-black uppercase">
                    <span id="goldStatus" class="text-emerald-500">● நேரலை</span>
                    <span id="metalTs" class="text-slate-300 leading-none">--</span>
                </div>
            </div>

            <!-- Balance -->
            <div onclick="showSalaryModal()" class="theme-primary p-10 rounded-[3.5rem] text-white shadow-2xl relative cursor-pointer overflow-hidden active:scale-[0.98] transition-all">
                <p class="text-[10px] font-black uppercase opacity-70 tracking-widest leading-none">சம்பளம் (திருத்த அழுத்தவும்)</p>
                <h2 id="dispSalary" class="text-5xl font-black my-2 tracking-tighter leading-tight">₹0</h2>
                <div id="deficitTag" class="mt-8 inline-block px-5 py-2 text-[9px] font-black rounded-full uppercase bg-white/20">கணக்கிடப்படுகிறது...</div>
            </div>

            <!-- Calendar -->
            <div class="theme-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 active:scale-90"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="text-center"><p id="calMonth" class="text-lg font-black italic leading-none">Month</p><p id="calYear" class="text-[9px] font-bold text-slate-300 uppercase mt-1">Year</p></div>
                    <button onclick="changeMonth(1)" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 active:scale-90"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div id="calGrid" class="grid grid-cols-7 gap-2"></div>
            </div>

            <div id="loanList" class="space-y-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 italic leading-none">EMI & சேமிப்புகள்</h3>
                <div id="loanItems" class="space-y-3"></div>
            </div>

            <div id="transSection" class="space-y-4 pb-12">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 italic leading-none">சமீபத்திய வரவு செலவு</h3>
                <div id="transList" class="space-y-3"></div>
            </div>
        </main>

        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t p-8 rounded-t-[3.5rem] flex justify-between items-center shadow-2xl z-[100]">
            <i class="fa-solid fa-house text-2xl text-indigo-500"></i>
            <div onclick="showAddModal()" class="w-16 h-16 theme-primary text-white rounded-3xl -mt-16 border-8 border-white flex items-center justify-center shadow-xl cursor-pointer active:scale-90 transition-transform"><i class="fa-solid fa-plus text-2xl"></i></div>
            <div class="flex gap-6">
                <i class="fa-solid fa-palette text-2xl text-slate-300 cursor-pointer hover:text-indigo-500" onclick="showThemeModal()"></i>
                <i class="fa-solid fa-gear text-2xl text-slate-300 cursor-pointer hover:text-indigo-500" onclick="initAppDB()"></i>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div id="emiModal" class="modal-overlay">
        <div class="bg-white w-full max-w-sm p-10 rounded-[4rem] shadow-2xl">
            <h3 class="text-xl font-black mb-8 italic text-center">EMI திருத்த</h3>
            <div class="space-y-6">
                <input type="text" id="emiName" readonly class="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold text-slate-400 shadow-inner text-center">
                <input type="number" id="emiAmt" placeholder="தொகை ₹" class="w-full p-5 bg-slate-50 rounded-2xl outline-none text-3xl font-black shadow-inner text-center">
                <input type="number" id="emiDate" placeholder="தேதி (1-31)" min="1" max="31" class="w-full p-5 bg-slate-50 rounded-2xl outline-none font-bold text-center shadow-inner">
                <button onclick="updateEMI()" id="btn-save-emi" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg">சேமி</button>
                <button onclick="closeModals()" class="w-full py-2 text-[10px] font-bold text-slate-300 uppercase underline">ரத்து</button>
            </div>
        </div>
    </div>

    <div id="themeModal" class="modal-overlay">
        <div class="bg-white w-full max-w-sm p-10 rounded-[4rem] shadow-2xl text-center">
            <h3 class="text-xl font-black mb-8 italic">தீம் மாற்றம்</h3>
            <div class="space-y-6">
                <input type="color" id="themeColorInp" oninput="applyThemePreview(this.value)" class="w-full h-12 rounded-xl cursor-pointer">
                <button onclick="saveThemeToCloud()" id="btn-theme-save" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase shadow-lg">விருப்பத்தைச் சேமி</button>
                <button onclick="closeModals()" class="w-full py-2 text-[10px] font-bold text-slate-300 uppercase underline leading-none">மூடுக</button>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay">
        <div class="bg-white w-full max-w-sm p-10 rounded-[4rem] shadow-2xl text-center">
            <div class="relative inline-block mb-6">
                <img id="profImg" src="" class="w-24 h-24 rounded-[2rem] object-cover border-4 border-slate-50 shadow-md">
                <label for="pUpload" class="absolute -bottom-1 -right-1 w-8 h-8 theme-primary text-white rounded-xl border-4 border-white flex items-center justify-center cursor-pointer shadow-sm"><i class="fa-solid fa-camera text-[10px]"></i><input type="file" id="pUpload" class="hidden" onchange="handlePhoto(event)"></label>
            </div>
            <input type="text" id="profNameInp" class="w-full p-5 bg-slate-50 rounded-2xl mb-4 font-bold text-center shadow-inner outline-none">
            <input type="password" id="profPassInp" class="w-full p-5 bg-slate-50 rounded-2xl mb-6 font-bold text-center shadow-inner outline-none" placeholder="புதிய கடவுச்சொல்">
            <button onclick="saveProfile()" id="btn-save-prof" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase shadow-lg">மாற்றங்களைச் சேமி</button>
            <button onclick="closeModals()" class="w-full py-2 mt-4 text-[10px] font-bold text-slate-300 uppercase underline">மூடுக</button>
        </div>
    </div>

    <div id="addModal" class="modal-overlay">
        <div class="bg-white w-full max-w-sm p-10 rounded-[4rem] shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-black mb-8 italic text-center">புதிய பதிவு</h3>
            <div class="flex gap-2 mb-8 p-1 bg-slate-50 rounded-2xl">
                <button onclick="setT('Expense')" id="tE" class="flex-1 py-3 rounded-xl font-bold text-[10px] bg-white text-rose-500 shadow-sm uppercase transition-all">செலவு</button>
                <button onclick="setT('Income')" id="tI" class="flex-1 py-3 rounded-xl font-bold text-[10px] text-slate-400 uppercase transition-all">வரவு</button>
                <button onclick="setT('Savings')" id="tS" class="flex-1 py-3 rounded-xl font-bold text-[10px] text-slate-400 uppercase transition-all">சேமிப்பு</button>
            </div>
            <div class="space-y-6">
                <input type="text" id="tCat" placeholder="வகைப்பாடு" class="w-full p-5 bg-slate-50 rounded-2xl font-bold shadow-inner outline-none text-center">
                <input type="number" id="tAmt" placeholder="தொகை ₹" class="w-full p-5 bg-slate-50 rounded-2xl text-4xl font-black shadow-inner outline-none text-center">
                <button onclick="addTransaction()" id="btn-add-t" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all">பதிவு செய்</button>
                <button onclick="closeModals()" class="w-full py-2 text-[10px] font-bold text-slate-300 uppercase underline">ரத்து</button>
            </div>
        </div>
    </div>

    <script>
        let G_URL = localStorage.getItem('kk_g'), session = null, transType = 'Expense', poller = null;
        let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();
        let lastActivity = Date.now(), autoLogoutEnabled = false, otpTimer = null;

        window.onload = () => {
            updateLiveTime(); setInterval(updateLiveTime, 1000);
            setInterval(checkInactivity, 60000);
            setInterval(checkGatewayConnectivity, 60000);
            simulateProgress();

            if(G_URL) {
                document.getElementById('gUrlInput').value = G_URL;
                updateGatewayStatusUI(true);
                const saved = localStorage.getItem('kk_session');
                if(saved && saved !== "undefined") {
                    try {
                        session = JSON.parse(saved);
                        if(session && session.sheetId) enterDashboard();
                        else hideSplash();
                    } catch(e) { hideSplash(); }
                } else hideSplash();
            } else hideSplash();
        };

        function simulateProgress() {
            let p = 0;
            const fill = document.getElementById('progress-fill');
            const txt = document.getElementById('progress-text');
            const int = setInterval(() => {
                p += Math.floor(Math.random() * 25);
                if(p >= 100) { p = 100; clearInterval(int); }
                fill.style.width = p + '%';
                txt.innerText = `தயார் செய்யப்படுகிறது... ${p}%`;
            }, 100);
        }

        // --- Core UI Functions ---
        function updateAvatarUI() {
            if(!session) return;
            const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim().replace('#','');
            const url = session.photo || `https://ui-avatars.com/api/?name=${session.name || 'U'}&background=${primary}&color=fff`;
            document.getElementById('userAvatar').src = url;
            document.getElementById('profImg').src = url;
            document.getElementById('userNameUI').innerText = session.name || "பயனர்";
            document.getElementById('profNameInp').value = session.name || "";
            document.getElementById('autoLogoutToggle').checked = session.autoLogout === "true";
            autoLogoutEnabled = session.autoLogout === "true";
            document.getElementById('autoLogoutTimerDisplay').innerText = autoLogoutEnabled ? "10m ON" : "OFF";
        }

        function checkGatewayConnectivity() {
            if(!G_URL) return;
            call({ action: 'ping' }, (res) => {
                const status = res && res.status === "Success";
                updateGatewayStatusUI(status);
                if(!status && document.getElementById('dashboard').style.display === 'block') {
                    console.warn("Lost Gateway Connection");
                    logout(); 
                }
            });
        }

        function updateGatewayStatusUI(isConnected) {
            const dot = document.getElementById('gw-dot');
            const txt = document.getElementById('gw-status-text');
            if(isConnected) {
                dot.className = "gw-indicator connected";
                txt.innerText = "இணைக்கப்பட்டது";
                txt.className = "text-[8px] font-bold uppercase text-emerald-500";
            } else {
                dot.className = "gw-indicator disconnected";
                txt.innerText = "இணைக்கப்படவில்லை";
                txt.className = "text-[8px] font-bold uppercase text-rose-500";
            }
        }

        function resetInactivityTimer() { lastActivity = Date.now(); }
        function checkInactivity() {
            if(!autoLogoutEnabled || !session) return;
            const idle = (Date.now() - lastActivity) / 1000 / 60;
            if(idle >= 10) { alert("பாதுகாப்பு கருதி தானாக வெளியேற்றப்பட்டது!"); logout(); }
        }

        function handleLogoutToggle() {
            autoLogoutEnabled = document.getElementById('autoLogoutToggle').checked;
            document.getElementById('autoLogoutTimerDisplay').innerText = autoLogoutEnabled ? "10m ON" : "OFF";
            if(session) {
                session.autoLogout = String(autoLogoutEnabled);
                localStorage.setItem('kk_session', JSON.stringify(session));
                call({ action: 'updateConfig', key: 'AUTO_LOGOUT', value: String(autoLogoutEnabled), sheetId: session.sheetId }, () => {});
            }
        }

        // --- Network Logic ---
        async function call(p, cb) {
            if(!G_URL) return;
            const securedActions = ['updateProfile', 'register', 'updateLoan', 'updateConfig', 'updateSalary', 'updateTheme', 'addTransaction', 'updateEMIStatus'];
            if(securedActions.includes(p.action)) {
                try { 
                    const res = await fetch(G_URL, { method: 'POST', body: JSON.stringify(p) }); 
                    cb(await res.json()); 
                } catch(e) { cb({ status: "Error", msg: "Server Error" }); }
                return;
            }
            const n = 'cb'+Date.now();
            window[n] = (res) => { cb(res); delete window[n]; const s = document.getElementById(n); if(s) s.remove(); };
            const s = document.createElement('script'); s.id = n;
            s.src = `${G_URL}${G_URL.includes('?')?'&':'?'}callback=${n}&${new URLSearchParams(p).toString()}`;
            s.onerror = () => { cb({ status: "Error" }); };
            document.body.appendChild(s);
        }

        // --- Auth Actions ---
        function loginUser() {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
            if(!e || !p) return alert("விவரங்கள் தேவை!");
            toggleBtn('btn-login', true);
            call({ action: 'login', email: e, pass: p }, (res) => {
                toggleBtn('btn-login', false);
                if(res.status === "Success") { session = res; localStorage.setItem('kk_session', JSON.stringify(res)); enterDashboard(); }
                else alert(res.msg);
            });
        }

        function requestOTP() {
            const e = document.getElementById('loginEmail').value;
            if(!e) return alert("மின்னஞ்சல் தேவை!");
            call({ action: 'sendOTP', email: e }, (res) => {
                if(res.status === "Sent") { toggleAuth('otp'); startOtpCountdown(); }
                else alert("மின்னஞ்சல் அனுப்புவதில் பிழை!");
            });
        }

        function verifyOTP() {
            const inps = document.querySelectorAll('#auth-otp .otp-box');
            let otp = ""; inps.forEach(i => otp += i.value);
            if(otp.length < 6) return alert("6 இலக்க குறியீடு தேவை!");
            toggleBtn('btn-verify', true);
            call({ action: 'login', email: document.getElementById('loginEmail').value, otp: otp, isOtp: "true" }, (res) => {
                toggleBtn('btn-verify', false);
                if(res.status === "Success") { session = res; localStorage.setItem('kk_session', JSON.stringify(res)); enterDashboard(); }
                else alert(res.msg);
            });
        }

        function handleOtpPaste(e) {
            const data = e.clipboardData.getData('text').trim().slice(0, 6);
            if(!/^\d+$/.test(data)) return;
            const inps = document.querySelectorAll('#auth-otp .otp-box');
            data.split('').forEach((v, i) => { if(inps[i]) inps[i].value = v; });
            inps[Math.min(data.length, 5)].focus();
            e.preventDefault();
        }

        function moveNext(el, e) {
            if(e.key === "Backspace" && !el.value) el.previousElementSibling?.focus();
            else if(el.value && el.value.length === 1) el.nextElementSibling?.focus();
        }

        function registerAccount() {
            const n = document.getElementById('regName').value, e = document.getElementById('regEmail').value, p = document.getElementById('regPass').value;
            if(!n || !e || !p) return alert("அனைத்து விவரங்களும் தேவை!");
            toggleBtn('btn-reg', true);
            call({ action: 'register', name: n, email: e, pass: p }, (res) => {
                toggleBtn('btn-reg', false);
                if(res.status === "Success") { alert("பதிவு வெற்றி! இப்போது உள்நுழையவும்."); toggleAuth('login'); }
                else alert(res.msg);
            });
        }

        // --- Dashboard Actions ---
        function enterDashboard() {
            document.getElementById('init-view').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            if(session.theme) applyThemePreview(session.theme);
            updateAvatarUI();
            loadData();
            startPoller();
        }

        function loadData() {
            if(!session) return;
            call({ action: 'getAppData', sheetId: session.sheetId, month: calMonth, year: calYear }, (data) => {
                if(data.status !== "Success") return hideSplash();
                
                document.getElementById('rate22k').innerText = data.metalRates.gold22k;
                document.getElementById('rate24k').innerText = data.metalRates.gold24k;
                document.getElementById('rateSilver').innerText = data.metalRates.silver;
                document.getElementById('metalTs').innerText = `${data.metalRates.day}, ${data.metalRates.time}`;
                document.getElementById('dispSalary').innerText = `₹${Number(data.salary || 0).toLocaleString()}`;
                
                const dTag = document.getElementById('deficitTag');
                dTag.innerText = data.deficit < 0 ? `குறைவு: ₹${Math.abs(data.deficit).toLocaleString()}` : `மீதி: ₹${data.deficit.toLocaleString()}`;
                dTag.style.background = data.deficit < 0 ? '#ef4444' : 'rgba(255,255,255,0.2)';

                renderCalendar(data);
                renderLoans(data.loans || []);
                renderTransactions(data.transactions || []);
                hideSplash();
            });
        }

        function renderCalendar(data) {
            const grid = document.getElementById('calGrid'); grid.innerHTML = "";
            const fDay = new Date(calYear, calMonth, 1).getDay(), dInM = new Date(calYear, calMonth + 1, 0).getDate();
            for(let i=0; i<fDay; i++) grid.innerHTML += '<div></div>';
            for(let i=1; i<=dInM; i++) {
                const loan = (data.loans || []).find(l => Number(l.date) === i);
                grid.innerHTML += `<div class="cal-day ${loan?'emi-date':'bg-slate-50 text-slate-400'}">${i}</div>`;
            }
        }

        function renderLoans(loans) {
            const list = document.getElementById('loanItems'); list.innerHTML = "";
            loans.forEach(l => {
                const isPaid = l.status === 'Paid';
                list.innerHTML += `<div class="theme-card p-4 flex justify-between items-center ${isPaid?'opacity-60 bg-emerald-50':''}">
                    <div class="flex items-center gap-3" onclick="openEMIEdit('${l.name}', ${l.amount}, ${l.date})">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center font-black ${isPaid?'bg-emerald-100 text-emerald-600':'bg-rose-50 text-rose-500'}">${l.date}</div>
                        <div><h4 class="text-sm font-black">${l.name}</h4><p class="text-[9px] font-bold text-slate-400 uppercase">₹${Number(l.amount).toLocaleString()}</p></div>
                    </div>
                    <label class="switch"><input type="checkbox" ${isPaid?'checked':''} onchange="toggleEMI('${l.name}', this.checked)"><span class="slider"></span></label>
                </div>`;
            });
        }

        function renderTransactions(t) {
            const list = document.getElementById('transList'); list.innerHTML = "";
            if(!t.length) list.innerHTML = "<p class='text-center text-slate-200 py-6 font-bold text-[10px] uppercase'>பதிவுகள் இல்லை</p>";
            t.forEach(item => {
                const isE = item.type === 'Expense', isS = item.type === 'Savings';
                let cls = isE ? 'text-rose-500' : (isS ? 'text-indigo-500' : 'text-emerald-500');
                list.innerHTML += `<div class="theme-card p-4 flex justify-between items-center border-none bg-slate-50/50">
                    <div><h4 class="text-sm font-black">${item.category}</h4><p class="text-[8px] font-bold text-slate-300 uppercase leading-none mt-1">${item.date}</p></div>
                    <p class="text-sm font-black ${cls}">${isE || isS ? '-' : '+'}₹${Number(item.amount).toLocaleString()}</p>
                </div>`;
            });
        }

        // --- Actions ---
        function openEMIEdit(n, a, d) {
            document.getElementById('emiName').value = n;
            document.getElementById('emiAmt').value = a;
            document.getElementById('emiDate').value = d;
            document.getElementById('emiModal').style.display = 'flex';
        }
        function updateEMI() {
            const n = document.getElementById('emiName').value, a = document.getElementById('emiAmt').value, d = document.getElementById('emiDate').value;
            toggleBtn('btn-save-emi', true);
            call({ action: 'updateLoan', loanName: n, amount: a, dueDate: d, sheetId: session.sheetId }, (res) => {
                toggleBtn('btn-save-emi', false);
                if(res.status === "Success") { closeModals(); loadData(); }
            });
        }
        function saveProfile() {
            const n = document.getElementById('profNameInp').value, p = document.getElementById('profPassInp').value;
            toggleBtn('btn-save-prof', true);
            call({ action: 'updateProfile', sheetId: session.sheetId, newName: n, newPass: p, photoData: session.photo }, (res) => {
                toggleBtn('btn-save-prof', false);
                if(res.status === "Success") { if(n) session.name = n; updateAvatarUI(); closeModals(); alert("சுயவிவரம் புதுப்பிக்கப்பட்டது!"); }
            });
        }
        function addTransaction() {
            const a = document.getElementById('tAmt').value, c = document.getElementById('tCat').value;
            if(!a || !c) return alert("தொகை மற்றும் வகைப்பாடு தேவை!");
            toggleBtn('btn-add-t', true);
            call({ action: 'addTransaction', amount: a, category: c, type: transType, sheetId: session.sheetId }, () => {
                toggleBtn('btn-add-t', false); closeModals(); loadData();
            });
        }

        // --- Helpers ---
        function startPoller() { if(poller) clearInterval(poller); poller = setInterval(silentSync, 300000); }
        function silentSync() {
            const ind = document.getElementById('syncIndicator'); ind.parentElement.classList.add('syncing-active');
            call({ action: 'getAppData', sheetId: session.sheetId, month: calMonth, year: calYear }, (data) => {
                if(data.status === "Success") loadData();
                setTimeout(() => ind.parentElement.classList.remove('syncing-active'), 2000);
            });
        }
        function applyThemePreview(c) { document.documentElement.style.setProperty('--primary-color', c); document.getElementById('themeColorInp').value = c; }
        function saveThemeToCloud() {
            const c = document.getElementById('themeColorInp').value;
            toggleBtn('btn-theme-save', true);
            call({ action: 'updateTheme', themeData: JSON.stringify(c), sheetId: session.sheetId }, (res) => {
                toggleBtn('btn-theme-save', false); if(res.status === "Success") { session.theme = c; localStorage.setItem('kk_session', JSON.stringify(session)); closeModals(); }
            });
        }
        function toggleEMI(n, c) { call({ action: 'updateEMIStatus', loanName: n, status: c?'Paid':'Pending', month: calMonth, year: calYear, sheetId: session.sheetId }, () => loadData()); }
        function logout() { localStorage.clear(); location.reload(); }
        function saveGateway() { const u = document.getElementById('gUrlInput').value.trim(); if(u.includes('/exec')) { localStorage.setItem('kk_g', u); location.reload(); } }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
        function showAddModal() { document.getElementById('addModal').style.display='flex'; }
        function showProfileModal() { document.getElementById('profileModal').style.display='flex'; }
        function showThemeModal() { document.getElementById('themeModal').style.display='flex'; }
        function showSalaryModal() { const s = prompt("புதிய சம்பளம்:"); if(s) call({ action: 'updateSalary', amount: s, sheetId: session.sheetId }, () => loadData()); }
        function toggleBtn(id, l) { const b = document.getElementById(id); b.disabled = l; b.innerHTML = l ? '<i class="fa-solid fa-spinner fa-spin"></i>' : (b.dataset.label || b.innerText); if(l) b.dataset.label = b.innerText; }
        function toggleAuth(s) { document.querySelectorAll('.screen').forEach(sc => sc.classList.remove('active')); document.getElementById('auth-' + s).classList.add('active'); }
        function updateLiveTime() { const n = new Date(); document.getElementById('liveClock').innerText = n.toLocaleTimeString('ta-IN'); }
        function changeMonth(o) { calMonth += o; if(calMonth>11){calMonth=0;calYear++;} if(calMonth<0){calMonth=11;calYear--;} loadData(); }
        function initAppDB() { if(confirm("தயார் செய்யவா?")) call({ action: 'initSetup', sheetId: session.sheetId }, (res) => alert(res.msg)); }
        function setT(t) { transType = t; document.getElementById('tE').className = t==='Expense'?'flex-1 py-3 rounded-xl font-bold text-[10px] bg-white text-rose-500 shadow-sm uppercase':'flex-1 py-3 rounded-xl font-bold text-[10px] text-slate-400 uppercase'; document.getElementById('tI').className = t==='Income'?'flex-1 py-3 rounded-xl font-bold text-[10px] bg-white text-emerald-500 shadow-sm uppercase':'flex-1 py-3 rounded-xl font-bold text-[10px] text-slate-400 uppercase'; document.getElementById('tS').className = t==='Savings'?'flex-1 py-3 rounded-xl font-bold text-[10px] bg-white text-indigo-500 shadow-sm uppercase':'flex-1 py-3 rounded-xl font-bold text-[10px] text-slate-400 uppercase'; }
        function handlePhoto(ev) {
            const f = ev.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = (e) => {
                const i = new Image(); i.src = e.target.result; i.onload = () => {
                    const c = document.createElement('canvas'), x = c.getContext('2d');
                    c.width = 150; c.height = 150; x.drawImage(i, 0,0,150,150);
                    session.photo = c.toDataURL('image/jpeg', 0.6);
                    document.getElementById('profImg').src = session.photo;
                }
            }; r.readAsDataURL(f);
        }
        function startOtpCountdown() {
            let t = 60; const el = document.getElementById('otpTimer');
            if(otpTimer) clearInterval(otpTimer);
            otpTimer = setInterval(() => { t--; el.innerText = `நேரம்: ${t}s`; if(t <= 0) clearInterval(otpTimer); }, 1000);
        }
        function hideSplash() { const s = document.getElementById('splash'); if(s) { s.style.opacity='0'; setTimeout(()=> { if(s.parentNode) s.remove(); }, 500); } }
    </script>
</body>
</html>
