<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasu-Kandhu Pro v4.1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .no-select { user-select: none; }
        .screen { display: none; }
        .active-screen { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-nav { color: #4f46e5; border-top: 3px solid #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 no-select font-sans pb-24">

    <div id="loginPage" class="fixed inset-0 bg-slate-900 flex items-center justify-center p-4 z-[99999]">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-3xl font-black text-indigo-700 italic mb-8">‡Æï‡Ææ‡Æö‡ØÅ-‡Æï‡Æ®‡Øç‡Æ§‡ØÅ</h1>
            <div id="emailStep">
                <input type="email" id="userEmail" placeholder="‡ÆÆ‡Æø‡Æ©‡Øç‡Æ©‡Æû‡Øç‡Æö‡Æ≤‡Øç" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 text-center outline-none">
                <button onclick="sendOTP()" id="otpBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">OTP ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ</button>
            </div>
            <div id="otpStep" class="hidden">
                <input type="number" id="otpInput" placeholder="000000" class="w-full p-4 border rounded-2xl mb-4 text-center text-2xl font-black tracking-[10px]">
                <button onclick="verifyOTP()" id="verifyBtn" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold">‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà</button>
            </div>
            <button onclick="document.getElementById('loginSetup').classList.toggle('hidden')" class="mt-8 text-[10px] text-slate-300 font-bold uppercase tracking-widest">‚öôÔ∏è First Time Setup</button>
            <div id="loginSetup" class="hidden mt-4 p-4 bg-slate-50 rounded-2xl border border-dashed text-left">
                <input type="text" id="loginUrlInput" placeholder="Apps Script URL" class="w-full p-3 text-xs mb-2 border rounded-xl outline-none">
                <input type="password" id="loginKeyInput" placeholder="Secret Key" class="w-full p-3 text-xs border rounded-xl outline-none">
                <button onclick="saveFromLogin()" class="w-full mt-3 bg-slate-800 text-white py-2 rounded-xl text-[10px] font-bold uppercase">Save Config</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="bg-white p-5 shadow-sm border-b flex justify-between items-center sticky top-0 z-50">
            <h1 id="topBarTitle" class="font-black text-slate-800 italic uppercase">‡ÆÆ‡ØÅ‡Æï‡Æ™‡Øç‡Æ™‡ØÅ</h1>
            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold">N</div>
        </header>

        <main class="container mx-auto p-4 max-w-md">
            <div id="homeScreen" class="screen active-screen space-y-6">
                <div class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-xl shadow-indigo-200">
                    <p class="text-indigo-100 text-sm">‡Æá‡Æ®‡Øç‡Æ§ ‡ÆÆ‡Ææ‡Æ§ ‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æö‡ØÜ‡Æ≤‡Æµ‡ØÅ</p>
                    <h2 id="totalExpenseDisplay" class="text-4xl font-black mt-1">‚Çπ 0</h2>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] shadow-lg border border-slate-100">
                    <canvas id="expenseChart" class="max-h-[250px]"></canvas>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] shadow-lg border border-slate-100">
                    <form id="transactionForm" class="space-y-4">
                        <input type="number" id="amount" placeholder="‡Æ§‡Øä‡Æï‡Øà ‚Çπ" class="w-full p-4 bg-slate-50 rounded-2xl text-xl font-bold outline-none border" required>
                        <select id="category" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border outline-none">
                            <option value="EMI">EMI</option>
                            <option value="Expense">‡Æö‡ØÜ‡Æ≤‡Æµ‡ØÅ</option>
                            <option value="Savings">‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ</option>
                        </select>
                        <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">Sheets-‡Æ≤‡Øç ‡Æö‡Øá‡ÆÆ‡Æø</button>
                    </form>
                </div>
            </div>

            <div id="historyScreen" class="screen space-y-4">
                <h3 class="font-bold text-slate-500 uppercase text-xs tracking-widest text-center mb-6">‡Æï‡Æü‡Øà‡Æö‡Æø 20 ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç</h3>
                <div id="historyList" class="space-y-3">
                    </div>
            </div>

            <div id="settingsScreen" class="screen space-y-6">
                <div class="bg-white p-8 rounded-[2.5rem] shadow-lg border border-slate-100">
                    <h3 class="font-black text-slate-800 mb-6 italic uppercase underline decoration-indigo-200">‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç</h3>
                    <div class="space-y-4">
                        <input type="text" id="apiUrlSettings" placeholder="Apps Script URL" class="w-full p-4 bg-slate-50 border rounded-2xl text-xs outline-none">
                        <input type="password" id="apiKeySettings" placeholder="Secret Key" class="w-full p-4 bg-slate-50 border rounded-2xl text-xs outline-none">
                        <button onclick="saveFromSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg uppercase text-xs">Update Settings</button>
                        <button onclick="location.reload()" class="w-full bg-red-50 text-red-500 py-4 rounded-2xl font-bold text-xs border border-red-100 uppercase mt-4 tracking-widest">Logout</button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-slate-200 flex justify-around p-3 z-50">
            <button onclick="changeScreen('home')" id="nav-home" class="flex flex-col items-center gap-1 active-nav flex-1">
                <span class="text-xl">üè†</span>
                <span class="text-[10px] font-bold">Home</span>
            </button>
            <button onclick="changeScreen('history')" id="nav-history" class="flex flex-col items-center gap-1 flex-1">
                <span class="text-xl">üìú</span>
                <span class="text-[10px] font-bold">History</span>
            </button>
            <button onclick="changeScreen('settings')" id="nav-settings" class="flex flex-col items-center gap-1 flex-1">
                <span class="text-xl">‚öôÔ∏è</span>
                <span class="text-[10px] font-bold">Settings</span>
            </button>
        </nav>
    </div>

    <script>
        let WEB_APP_URL = localStorage.getItem('k_url') || "";
        let SECRET_KEY = localStorage.getItem('k_key') || "";
        let SESSION_TOKEN = "";
        let myChart = null;

        window.onload = () => {
            document.getElementById('loginUrlInput').value = WEB_APP_URL;
            document.getElementById('loginKeyInput').value = SECRET_KEY;
            document.getElementById('apiUrlSettings').value = WEB_APP_URL;
            document.getElementById('apiKeySettings').value = SECRET_KEY;
        };

        function saveFromLogin() {
            WEB_APP_URL = document.getElementById('loginUrlInput').value.trim();
            SECRET_KEY = document.getElementById('loginKeyInput').value.trim();
            localStorage.setItem('k_url', WEB_APP_URL);
            localStorage.setItem('k_key', SECRET_KEY);
            alert("Settings Saved!");
        }

        function saveFromSettings() {
            WEB_APP_URL = document.getElementById('apiUrlSettings').value.trim();
            SECRET_KEY = document.getElementById('apiKeySettings').value.trim();
            localStorage.setItem('k_url', WEB_APP_URL);
            localStorage.setItem('k_key', SECRET_KEY);
            alert("Settings Updated!");
            location.reload();
        }

        function changeScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
            document.getElementById(screenId + 'Screen').classList.add('active-screen');
            document.getElementById('nav-' + screenId).classList.add('active-nav');
            document.getElementById('topBarTitle').innerText = screenId.toUpperCase();
            if(screenId === 'home') loadDashboard();
            if(screenId === 'history') loadHistory();
        }

        function jsonpFetch(params) {
            return new Promise((resolve) => {
                const cb = 'cb_' + Math.round(100000 * Math.random());
                window[cb] = (d) => { resolve(d); delete window[cb]; document.body.removeChild(s); };
                const s = document.createElement('script');
                s.src = `${WEB_APP_URL}?callback=${cb}&${new URLSearchParams(params).toString()}`;
                document.body.appendChild(s);
            });
        }

        async function sendOTP() {
            if(!WEB_APP_URL) return alert("Setup API first!");
            const btn = document.getElementById('otpBtn');
            btn.innerText = "Connecting..."; btn.disabled = true;
            const res = await jsonpFetch({ action: "sendOTP", email: document.getElementById('userEmail').value });
            if(res.status === "Sent") {
                document.getElementById('emailStep').classList.add('hidden');
                document.getElementById('otpStep').classList.remove('hidden');
            } else { alert("Error!"); btn.disabled = false; btn.innerText = "OTP ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ"; }
        }

        async function verifyOTP() {
            const res = await jsonpFetch({ action: "verifyOTP", otp: document.getElementById('otpInput').value });
            if(res.status === "Success") {
                SESSION_TOKEN = res.token;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadDashboard();
            } else { alert("Wrong OTP!"); }
        }

        async function loadDashboard() {
            const data = await jsonpFetch({ action: "getDashboardData" });
            document.getElementById('totalExpenseDisplay').innerText = `‚Çπ ${data.Total.toLocaleString('en-IN')}`;
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['EMI', 'Expense', 'Savings'],
                    datasets: [{
                        data: [data.EMI, data.Expense, data.Savings],
                        backgroundColor: ['#4f46e5', '#fbbf24', '#10b981'],
                        borderWidth: 6, borderColor: '#ffffff'
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } }, cutout: '75%' }
            });
        }

        async function loadHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = "<p class='text-center text-slate-300'>Loading...</p>";
            const data = await jsonpFetch({ action: "getHistory" });
            list.innerHTML = data.map(item => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-slate-800 tracking-tight">‚Çπ ${item.amount}</p>
                        <p class="text-[10px] text-slate-400 uppercase font-black">${item.category} ‚Ä¢ ${item.date}</p>
                    </div>
                    <div class="text-[10px] bg-slate-50 px-3 py-1 rounded-lg text-slate-400 font-bold">${item.desc || 'No Desc'}</div>
                </div>
            `).join('');
        }

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const q = new URLSearchParams({
                amount: document.getElementById('amount').value,
                category: document.getElementById('category').value,
                token: SESSION_TOKEN,
                key: SECRET_KEY
            }).toString();
            await fetch(`${WEB_APP_URL}?${q}`, { method: 'POST', mode: 'no-cors' });
            alert("‚úÖ Saved!");
            document.getElementById('transactionForm').reset();
            loadDashboard();
        });
    </script>
</body>
</html>
