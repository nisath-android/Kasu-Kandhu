<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <title>Kasu-Kandhu v3.7 | Zero-CORS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 font-sans text-slate-800">

    <div id="loginPage" class="fixed inset-0 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-3xl font-black text-indigo-700 mb-6 italic tracking-tighter uppercase">காசு-கந்து</h1>
            
            <div id="emailStep">
                <input type="email" id="userEmail" placeholder="மின்னஞ்சல்" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 text-center outline-none focus:ring-2 focus:ring-indigo-500">
                <button onclick="sendOTP()" id="otpBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">OTP அனுப்பு</button>
            </div>

            <div id="otpStep" class="hidden">
                <input type="number" id="otpInput" placeholder="000000" class="w-full p-4 border rounded-2xl mb-4 text-center text-2xl font-black tracking-[10px]">
                <button onclick="verifyOTP()" id="verifyBtn" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold">உள்நுழை (Verify)</button>
            </div>

            <button onclick="document.getElementById('setup').classList.toggle('hidden')" class="mt-8 text-[10px] text-slate-300">⚙️ API Config</button>
            <div id="setup" class="hidden mt-4 p-4 bg-slate-50 rounded-xl border border-dashed border-slate-300 text-left">
                <input type="text" id="apiUrlInitial" placeholder="Apps Script URL" class="w-full p-2 text-xs mb-2 rounded border">
                <input type="password" id="apiKeyInitial" placeholder="Secret Key" class="w-full p-2 text-xs rounded border mb-2">
                <button onclick="saveInitialConfig()" class="w-full bg-slate-800 text-white text-[10px] py-2 rounded font-bold uppercase">Save</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen bg-slate-100">
        <header class="bg-white p-5 shadow flex justify-between items-center">
            <h1 class="font-black text-indigo-600 italic">KASU-KANDHU PRO</h1>
            <button onclick="location.reload()" class="text-xs bg-red-50 text-red-500 px-4 py-1 rounded-full border border-red-100">LOGOUT</button>
        </header>
        <main class="p-6 max-w-md mx-auto">
            <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-200">
                <form id="transactionForm" class="space-y-5">
                    <input type="number" id="amount" placeholder="Amount" class="w-full p-4 bg-slate-50 rounded-xl text-xl font-bold outline-none border" required>
                    <select id="category" class="w-full p-4 bg-slate-50 rounded-xl font-bold text-slate-600 outline-none border">
                        <option value="EMI">EMI</option>
                        <option value="Expense">Expense</option>
                        <option value="Savings">Savings</option>
                    </select>
                    <input type="text" id="description" placeholder="Description" class="w-full p-4 bg-slate-50 rounded-xl outline-none border">
                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg">Save to Sheets</button>
                </form>
            </div>
        </main>
    </div>

    <script>
        let WEB_APP_URL = localStorage.getItem('k_url') || "";
        let SECRET_KEY = localStorage.getItem('k_key') || "";
        let SESSION_TOKEN = "";

        function saveInitialConfig() {
            localStorage.setItem('k_url', document.getElementById('apiUrlInitial').value.trim());
            localStorage.setItem('k_key', document.getElementById('apiKeyInitial').value.trim());
            location.reload();
        }

        // --- JSONP HELPER ---
        function jsonpFetch(url, params) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(data);
                };
                
                const script = document.createElement('script');
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName + '&' + new URLSearchParams(params).toString();
                script.onerror = reject;
                document.body.appendChild(script);
            });
        }

        async function sendOTP() {
            if(!WEB_APP_URL) return alert("URL Missing!");
            const btn = document.getElementById('otpBtn');
            btn.innerText = "Connecting..."; btn.disabled = true;

            try {
                const res = await jsonpFetch(WEB_APP_URL, { 
                    action: "sendOTP", 
                    email: document.getElementById('userEmail').value 
                });
                if(res.status === "Sent") {
                    document.getElementById('emailStep').classList.add('hidden');
                    document.getElementById('otpStep').classList.remove('hidden');
                } else { alert("Denied!"); btn.disabled = false; }
            } catch(e) { alert("Network Error. Check URL!"); btn.disabled = false; }
        }

        async function verifyOTP() {
            const btn = document.getElementById('verifyBtn');
            btn.innerText = "Checking..."; btn.disabled = true;
            try {
                const res = await jsonpFetch(WEB_APP_URL, { 
                    action: "verifyOTP", 
                    otp: document.getElementById('otpInput').value 
                });
                if(res.status === "Success") {
                    SESSION_TOKEN = res.token;
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                } else { alert("Wrong OTP!"); btn.disabled = false; }
            } catch(e) { alert("Error!"); btn.disabled = false; }
        }

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "Saving..."; btn.disabled = true;
            const q = new URLSearchParams({
                amount: document.getElementById('amount').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                token: SESSION_TOKEN,
                key: SECRET_KEY
            }).toString();

            try {
                // POST to GAS with no-cors works fine for sending data
                await fetch(`${WEB_APP_URL}?${q}`, { method: 'POST', mode: 'no-cors' });
                alert("✅ Saved!");
                document.getElementById('transactionForm').reset();
            } catch(e) { alert("Error!"); }
            finally { btn.disabled = false; btn.innerText = "Save to Sheets"; }
        });

        document.getElementById('apiUrlInitial').value = WEB_APP_URL;
        document.getElementById('apiKeyInitial').value = SECRET_KEY;
    </script>
</body>
</html>
