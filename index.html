/**
 * Project: Kasu-Kandhu Serverless
 * Version: 4.1.1 (Full Feature Backend)
 */

var ss = SpreadsheetApp.getActiveSpreadsheet();
var props = PropertiesService.getScriptProperties();

function createResponse(content, callback) {
  var jsonString = JSON.stringify(content);
  if (callback) {
    return ContentService.createTextOutput(callback + "(" + jsonString + ")")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return ContentService.createTextOutput(jsonString).setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  if (!e || !e.parameter) return ContentService.createTextOutput("API Active");
  var action = e.parameter.action;
  var callback = e.parameter.callback;

  try {
    if (action == "sendOTP") {
      var email = e.parameter.email;
      var configSheet = ss.getSheetByName("Config");
      var data = configSheet.getDataRange().getValues();
      var allowedEmail = "";
      data.forEach(function(row) { if(row[0] == "ALLOWED_EMAIL") allowedEmail = row[1]; });

      if (email.toLowerCase().trim() === allowedEmail.toString().toLowerCase().trim()) {
        var otp = Math.floor(100000 + Math.random() * 900000).toString();
        props.setProperty('CURRENT_OTP', otp);
        props.setProperty('OTP_EXPIRY', new Date().getTime() + 300000);
        MailApp.sendEmail(email, "Kasu-Kandhu Login OTP", "உங்கள் லாகின் குறியீடு: " + otp);
        return createResponse({status: "Sent"}, callback);
      }
      return createResponse({status: "Unauthorized"}, callback);
    }

    if (action == "verifyOTP") {
      var userOtp = e.parameter.otp;
      if (new Date().getTime() < props.getProperty('OTP_EXPIRY') && userOtp === props.getProperty('CURRENT_OTP')) {
        var token = Utilities.getUuid();
        props.setProperty('SESSION_' + token, 'active');
        return createResponse({status: "Success", token: token}, callback);
      }
      return createResponse({status: "Failed"}, callback);
    }

    if (action == "getDashboardData") {
      var sheet = ss.getSheetByName("Transactions");
      var summary = { EMI: 0, Expense: 0, Savings: 0, Total: 0 };
      if (sheet) {
        var rows = sheet.getDataRange().getValues();
        for (var i = 1; i < rows.length; i++) {
          var cat = rows[i][1];
          var amt = parseFloat(rows[i][2]) || 0;
          if (summary.hasOwnProperty(cat)) { summary[cat] += amt; summary.Total += amt; }
        }
      }
      return createResponse(summary, callback);
    }

    if (action == "getHistory") {
      var sheet = ss.getSheetByName("Transactions");
      var history = [];
      if (sheet) {
        var rows = sheet.getDataRange().getValues();
        for (var i = rows.length - 1; i >= Math.max(1, rows.length - 20); i--) {
          history.push({
            date: Utilities.formatDate(new Date(rows[i][0]), "GMT+5:30", "dd MMM"),
            category: rows[i][1],
            amount: rows[i][2],
            desc: rows[i][3]
          });
        }
      }
      return createResponse(history, callback);
    }
  } catch (err) { return createResponse({status: "Error", message: err.toString()}, callback); }
}

function doPost(e) {
  var data = e.parameter;
  var configData = ss.getSheetByName("Config").getDataRange().getValues();
  var settings = {}; configData.forEach(r => settings[r[0]] = r[1]);
  if (props.getProperty('SESSION_' + data.token) !== 'active' || data.key !== settings["SECRET_KEY"]) {
    return ContentService.createTextOutput("Forbidden").setMimeType(ContentService.MimeType.TEXT);
  }
  var sheet = ss.getSheetByName("Transactions") || ss.insertSheet("Transactions");
  sheet.appendRow([new Date(), data.category, data.amount, data.description || "", "Expense"]);
  return ContentService.createTextOutput("Success");
}
