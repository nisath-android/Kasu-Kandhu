<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasu-Kandhu Elite v5.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-select { user-select: none; }
        .screen { display: none; }
        .active-screen { display: block; animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner CSS */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360px); } }
        
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        .fab-active { transform: rotate(45deg); background-color: #ef4444 !important; }
        .modal-active { display: flex !important; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-[#F8FAFC] no-select pb-28">

    <div id="loginPage" class="fixed inset-0 bg-[#0F172A] flex items-center justify-center p-6 z-[99999]">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-4xl font-extrabold text-indigo-600 italic tracking-tighter mb-2">‡Æï‡Ææ‡Æö‡ØÅ-‡Æï‡Æ®‡Øç‡Æ§‡ØÅ</h1>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-10">Elite Finance Manager</p>
            
            <div id="emailStep">
                <input type="email" id="userEmail" placeholder="‡ÆÆ‡Æø‡Æ©‡Øç‡Æ©‡Æû‡Øç‡Æö‡Æ≤‡Øç" class="w-full p-5 bg-slate-50 border-none rounded-3xl mb-4 text-center outline-none focus:ring-2 ring-indigo-500 font-semibold">
                <button onclick="sendOTP()" id="otpBtn" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-bold shadow-xl shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span id="otpBtnText">OTP ‡Æ™‡ØÜ‡Æ±‡ØÅ</span>
                </button>
            </div>

            <div id="otpStep" class="hidden">
                <input type="number" id="otpInput" placeholder="000000" class="w-full p-5 border-none bg-slate-50 rounded-3xl mb-4 text-center text-3xl font-black tracking-[10px] outline-none">
                <button onclick="verifyOTP()" id="verifyBtn" class="w-full bg-emerald-500 text-white py-5 rounded-3xl font-bold active:scale-95 transition-all flex items-center justify-center gap-2">
                    <span id="verifyBtnText">‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà</span>
                </button>
            </div>

            <button onclick="document.getElementById('loginSetup').classList.toggle('hidden')" class="mt-8 text-[10px] text-slate-300 font-bold uppercase tracking-widest">‚öôÔ∏è API Settings</button>
            <div id="loginSetup" class="hidden mt-4 p-5 bg-slate-50 rounded-[2rem] text-left">
                <input type="text" id="loginUrlInput" placeholder="Apps Script URL" class="w-full p-3 text-xs mb-2 border rounded-xl outline-none">
                <input type="password" id="loginKeyInput" placeholder="Secret Key" class="w-full p-3 text-xs border rounded-xl outline-none">
                <button onclick="saveFromLogin()" class="w-full mt-3 bg-slate-800 text-white py-3 rounded-xl text-[10px] font-bold">SAVE CONFIG</button>
            </div>
        </div>
    </div>

    <button onclick="toggleModal()" id="fab" class="fixed bottom-28 right-6 w-16 h-16 bg-indigo-600 text-white text-3xl rounded-full shadow-2xl shadow-indigo-300 flex items-center justify-center z-[100] transition-all duration-300 active:scale-90">
        +
    </button>

    <div id="entryModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-end justify-center z-[1000] p-4">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-extrabold text-slate-800">‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ</h3>
                <button onclick="toggleModal()" class="text-slate-400 text-2xl">√ó</button>
            </div>
            <form id="transactionForm" class="space-y-4">
                <select id="category" class="w-full p-5 bg-slate-50 rounded-3xl font-bold text-slate-700 outline-none">
                    <option value="Salary">üí∞ ‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ©‡ÆÆ‡Øç (Salary)</option>
                    <option value="EMI">üìâ EMI ‡Æï‡Æü‡Øç‡Æü‡Æ£‡ÆÆ‡Øç</option>
                    <option value="Expense">üõçÔ∏è ‡Æá‡Æ§‡Æ∞ ‡Æö‡ØÜ‡Æ≤‡Æµ‡ØÅ</option>
                    <option value="Savings">üè¶ ‡Æö‡Øá‡ÆÆ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ</option>
                </select>
                <input type="number" id="amount" placeholder="‚Çπ 0.00" class="w-full p-5 bg-slate-50 rounded-3xl text-2xl font-black outline-none border-none focus:ring-2 ring-indigo-500" required>
                <input type="text" id="description" placeholder="‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡ÆÆ‡Øç" class="w-full p-5 bg-slate-50 rounded-3xl outline-none font-medium">
                <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-bold shadow-xl flex items-center justify-center gap-2">
                    <span id="submitBtnText">SHEETS-‡Æ≤‡Øç ‡Æö‡Øá‡ÆÆ‡Æø</span>
                </button>
            </form>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="p-6 flex justify-between items-center sticky top-0 bg-[#F8FAFC]/80 backdrop-blur-md z-50">
            <div>
                <p id="currentDate" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"></p>
                <h1 id="topBarTitle" class="text-2xl font-black text-slate-800">‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! üëã</h1>
            </div>
            <div class="w-12 h-12 bg-indigo-600 rounded-2xl shadow-lg flex items-center justify-center text-white font-black text-xl">N</div>
        </header>

        <main class="px-6 space-y-6">
            <div id="homeScreen" class="screen active-screen space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-indigo-600 p-6 rounded-[2.5rem] shadow-xl text-white">
                        <p class="text-[9px] font-bold uppercase opacity-70">‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ©‡ÆÆ‡Øç</p>
                        <h2 id="salaryDisplay" class="text-xl font-black mt-1 tracking-tighter">‚Çπ 0</h2>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-xl text-slate-800 border border-slate-100">
                        <p class="text-[9px] font-bold uppercase text-slate-400">‡Æö‡ØÜ‡Æ≤‡Æµ‡ØÅ</p>
                        <h2 id="totalExpDisplay" class="text-xl font-black mt-1 text-red-500 tracking-tighter">‚Çπ 0</h2>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-[3rem] shadow-xl border border-slate-100 relative">
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ</p>
                        <h3 id="balanceDisplay" class="text-2xl font-black text-slate-800 tracking-tighter">‚Çπ 0</h3>
                    </div>
                    <canvas id="expenseChart" class="max-h-[250px] mx-auto"></canvas>
                </div>
            </div>

            <div id="historyScreen" class="screen space-y-4">
                <div id="historyList" class="space-y-4"></div>
            </div>

            <div id="settingsScreen" class="screen space-y-6">
                <div class="bg-white p-8 rounded-[3rem] shadow-xl">
                    <h3 class="font-black text-xl mb-6 italic uppercase">‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç</h3>
                    <div class="space-y-4">
                        <input type="text" id="apiUrlSettings" class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-bold outline-none">
                        <input type="password" id="apiKeySettings" class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-bold outline-none">
                        <button onclick="saveFromSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">UPDATE CONFIG</button>
                        <button onclick="location.reload()" class="w-full bg-red-50 text-red-500 py-4 rounded-2xl font-bold text-xs uppercase border border-red-100 mt-6 tracking-widest">Logout</button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-6 left-6 right-6 bg-slate-900 rounded-[2.5rem] p-3 flex justify-around shadow-2xl z-[90]">
            <button onclick="changeScreen('home')" id="nav-home" class="flex flex-col items-center gap-1 flex-1 text-indigo-400">
                <span class="text-xl">üè†</span>
                <span class="text-[9px] font-bold uppercase">Home</span>
            </button>
            <button onclick="changeScreen('history')" id="nav-history" class="flex flex-col items-center gap-1 flex-1 text-slate-500">
                <span class="text-xl">üìú</span>
                <span class="text-[9px] font-bold uppercase">History</span>
            </button>
            <button onclick="changeScreen('settings')" id="nav-settings" class="flex flex-col items-center gap-1 flex-1 text-slate-500">
                <span class="text-xl">‚öôÔ∏è</span>
                <span class="text-[9px] font-bold uppercase">Settings</span>
            </button>
        </nav>
    </div>

    <script>
        let WEB_APP_URL = localStorage.getItem('k_url') || "";
        let SECRET_KEY = localStorage.getItem('k_key') || "";
        let SESSION_TOKEN = "";
        let myChart = null;

        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ta-IN', { weekday: 'long', day: 'numeric', month: 'long' });

        // Helper: ‡Æ™‡Æü‡Øç‡Æü‡Æ©‡Øà ‡Æ≤‡Øã‡Æü‡Æø‡Æô‡Øç ‡Æ®‡Æø‡Æ≤‡Øà‡Æï‡Øç‡Æï‡ØÅ ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç
        function setBtnLoading(btnId, textId, isLoading) {
            const btn = document.getElementById(btnId);
            const text = document.getElementById(textId);
            const originalText = textId === 'otpBtnText' ? 'OTP ‡Æ™‡ØÜ‡Æ±‡ØÅ' : (textId === 'verifyBtnText' ? '‡Æâ‡Æ≥‡Øç‡Æ®‡ØÅ‡Æ¥‡Øà' : 'SHEETS-‡Æ≤‡Øç ‡Æö‡Øá‡ÆÆ‡Æø');
            
            if (isLoading) {
                btn.disabled = true;
                text.innerHTML = '<div class="spinner"></div>';
            } else {
                btn.disabled = false;
                text.innerHTML = originalText;
            }
        }

        function toggleModal() {
            document.getElementById('entryModal').classList.toggle('modal-active');
            document.getElementById('fab').classList.toggle('fab-active');
        }

        function saveFromLogin() {
            localStorage.setItem('k_url', document.getElementById('loginUrlInput').value);
            localStorage.setItem('k_key', document.getElementById('loginKeyInput').value);
            location.reload();
        }

        function saveFromSettings() {
            localStorage.setItem('k_url', document.getElementById('apiUrlSettings').value);
            localStorage.setItem('k_key', document.getElementById('apiKeySettings').value);
            alert("Updated!"); location.reload();
        }

        function changeScreen(scr) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.querySelectorAll('nav button').forEach(b => { b.classList.add('text-slate-500'); b.classList.remove('text-indigo-400'); });
            document.getElementById(scr + 'Screen').classList.add('active-screen');
            document.getElementById('nav-' + scr).classList.remove('text-slate-500');
            document.getElementById('nav-' + scr).classList.add('text-indigo-400');
            if(scr === 'home') loadDashboard();
            if(scr === 'history') loadHistory();
        }

        function jsonpFetch(params) {
            return new Promise(resolve => {
                const cb = 'cb_' + Math.round(100000 * Math.random());
                window[cb] = (d) => { resolve(d); delete window[cb]; document.body.removeChild(s); };
                const s = document.createElement('script');
                s.src = `${WEB_APP_URL}?callback=${cb}&${new URLSearchParams(params).toString()}`;
                document.body.appendChild(s);
            });
        }

        async function sendOTP() {
            setBtnLoading('otpBtn', 'otpBtnText', true);
            try {
                const res = await jsonpFetch({ action: "sendOTP", email: document.getElementById('userEmail').value });
                if(res.status === "Sent") {
                    document.getElementById('emailStep').classList.add('hidden');
                    document.getElementById('otpStep').classList.remove('hidden');
                } else { alert("Permission Denied"); }
            } catch(e) { alert("Error!"); }
            finally { setBtnLoading('otpBtn', 'otpBtnText', false); }
        }

        async function verifyOTP() {
            setBtnLoading('verifyBtn', 'verifyBtnText', true);
            try {
                const res = await jsonpFetch({ action: "verifyOTP", otp: document.getElementById('otpInput').value });
                if(res.status === "Success") {
                    SESSION_TOKEN = res.token;
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    loadDashboard();
                } else { alert("Invalid OTP!"); }
            } catch(e) { alert("Error!"); }
            finally { setBtnLoading('verifyBtn', 'verifyBtnText', false); }
        }

        async function loadDashboard() {
            const data = await jsonpFetch({ action: "getDashboardData" });
            const balance = data.Salary - data.TotalExp;
            document.getElementById('salaryDisplay').innerText = `‚Çπ ${data.Salary.toLocaleString()}`;
            document.getElementById('totalExpDisplay').innerText = `‚Çπ ${data.TotalExp.toLocaleString()}`;
            document.getElementById('balanceDisplay').innerText = `‚Çπ ${balance.toLocaleString()}`;

            const ctx = document.getElementById('expenseChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['EMI', 'Expense', 'Savings', 'Other'],
                    datasets: [{
                        data: [data.EMI, data.Expense, data.Savings, data.Other],
                        backgroundColor: ['#6366f1', '#fbbf24', '#10b981', '#94a3b8'],
                        borderWidth: 10, borderColor: '#ffffff', borderRadius: 20
                    }]
                },
                options: { animation: { duration: 2000 }, plugins: { legend: { display: false } }, cutout: '80%' }
            });
        }

        async function loadHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = "<p class='text-center text-slate-300 animate-pulse'>Fetching History...</p>";
            const data = await jsonpFetch({ action: "getHistory" });
            list.innerHTML = data.map(i => `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex justify-between items-center transition-all active:scale-95">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl ${i.category === 'Salary' ? 'bg-emerald-50 text-emerald-500' : 'bg-red-50 text-red-500'} flex items-center justify-center font-bold">
                            ${i.category === 'Salary' ? '‚Üì' : '‚Üë'}
                        </div>
                        <div><p class="font-extrabold text-slate-800 tracking-tight">${i.category}</p><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">${i.date}</p></div>
                    </div>
                    <p class="font-black ${i.category === 'Salary' ? 'text-emerald-500' : 'text-slate-800'}">‚Çπ ${parseFloat(i.amount).toLocaleString()}</p>
                </div>
            `).join('');
        }

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            setBtnLoading('submitBtn', 'submitBtnText', true);
            const q = new URLSearchParams({
                amount: document.getElementById('amount').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                token: SESSION_TOKEN, key: SECRET_KEY
            }).toString();

            try {
                await fetch(`${WEB_APP_URL}?${q}`, { method: 'POST', mode: 'no-cors' });
                toggleModal();
                document.getElementById('transactionForm').reset();
                loadDashboard();
            } catch(e) { alert("Error!"); }
            finally { setBtnLoading('submitBtn', 'submitBtnText', false); }
        });
        
        document.getElementById('apiUrlSettings').value = WEB_APP_URL;
        document.getElementById('apiKeySettings').value = SECRET_KEY;
    </script>
</body>
</html>
