<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasu-Kandhu | OTP Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 font-sans">

    <div id="loginPage" class="fixed inset-0 bg-indigo-900 flex items-center justify-center p-4 z-[100]">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-indigo-700 mb-6 italic">роХро╛роЪрпБ-роХроирпНродрпБ Login</h1>
            
            <div id="emailStep">
                <input type="email" id="userEmail" placeholder="роЙроЩрпНроХро│рпН рооро┐ройрпНройроЮрпНроЪро▓рпН" class="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-indigo-500 text-center">
                <button onclick="sendOTP()" id="otpBtn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Send OTP</button>
            </div>

            <div id="otpStep" class="hidden">
                <p class="text-sm text-slate-500 mb-4 font-medium">роорпЖропро┐ро▓рпБроХрпНроХрпБ ро╡роирпНрод OTP-роР роЙро│рпНро│ро┐роЯро╡рпБроорпН</p>
                <input type="number" id="otpInput" placeholder="6-digit OTP" class="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-indigo-500 text-center tracking-[10px] text-xl font-bold">
                <button onclick="verifyOTP()" id="verifyBtn" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">Verify & Login</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <header class="bg-indigo-700 p-5 text-white flex justify-between items-center shadow-lg">
            <h1 class="text-xl font-bold italic">ЁЯЫбя╕П Kasu-Kandhu Dashboard</h1>
            <button onclick="toggleSettings()" class="bg-indigo-800 p-2 rounded-lg">тЪЩя╕П</button>
        </header>

        <main class="container mx-auto p-6 max-w-md">
            <div class="bg-white p-8 rounded-2xl shadow-md">
                <form id="transactionForm" class="space-y-4">
                    <input type="number" id="amount" placeholder="родрпКроХрпИ" class="w-full p-4 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <select id="category" class="w-full p-4 bg-slate-50 border rounded-xl">
                        <option value="EMI">EMI</option>
                        <option value="Expense">роЪрпЖро▓ро╡рпБ</option>
                        <option value="Savings">роЪрпЗрооро┐рокрпНрокрпБ</option>
                    </select>
                    <input type="text" id="description" placeholder="ро╡ро┐ро│роХрпНроХроорпН" class="w-full p-4 bg-slate-50 border rounded-xl outline-none">
                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-700">роЪрпЗрооро┐</button>
                </form>
            </div>
        </main>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[110]">
        <div class="bg-white p-6 rounded-2xl w-full max-w-xs shadow-xl">
            <h3 class="font-bold mb-4">API Configuration</h3>
            <input type="text" id="apiUrlInput" placeholder="Apps Script URL" class="w-full p-2 border rounded-lg mb-3 text-sm">
            <input type="password" id="apiKeyInput" placeholder="Secret Key" class="w-full p-2 border rounded-lg mb-4 text-sm">
            <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold">Save</button>
            <button onclick="toggleSettings()" class="w-full mt-2 text-slate-400 text-sm">Close</button>
        </div>
    </div>

    <script>
        let WEB_APP_URL = localStorage.getItem('kasu_kandhu_url') || "";
        let SECRET_KEY = localStorage.getItem('kasu_kandhu_key') || "";

        async function sendOTP() {
            if(!WEB_APP_URL) { alert("роорпБродро▓ро┐ро▓рпН Settings-ро▓рпН URL-роРроЪрпН роЪрпЗрооро┐роХрпНроХро╡рпБроорпН!"); toggleSettings(); return; }
            const email = document.getElementById('userEmail').value;
            const btn = document.getElementById('otpBtn');
            btn.innerText = "роЕройрпБрокрпНрокрокрпНрокроЯрпБроХро┐ро▒родрпБ...";
            
            const res = await fetch(`${WEB_APP_URL}?action=sendOTP&email=${email}`);
            const text = await res.text();
            
            if (text === "Sent") {
                document.getElementById('emailStep').classList.add('hidden');
                document.getElementById('otpStep').classList.remove('hidden');
            } else {
                alert("родро╡ро▒ро╛рой рооро┐ройрпНройроЮрпНроЪро▓рпН роЕро▓рпНро▓родрпБ рокро┐ро┤рпИ!");
                btn.innerText = "Send OTP";
            }
        }

        async function verifyOTP() {
            const otp = document.getElementById('otpInput').value;
            const btn = document.getElementById('verifyBtn');
            btn.innerText = "роЪро░ро┐рокро╛ро░рпНроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ...";

            const res = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "verifyOTP", otp: otp })
            });
            
            // Note: no-cors-ро▓рпН ро░рпЖро╕рпНрокро╛ройрпНро╕рпН рокроЯро┐роХрпНроХ роорпБроЯро┐ропро╛родрпБ роОройрпНрокродро╛ро▓рпН, 
            // роиро╛роорпН роорпАрогрпНроЯрпБроорпН роТро░рпБроорпБро▒рпИ роОро│ро┐роп GET роорпВро▓роорпН роЪро░ро┐рокро╛ро░рпНроХрпНроХро▓ро╛роорпН роЕро▓рпНро▓родрпБ 
            // родро▒рпНроХро╛ро▓ро┐роХрооро╛роХ роЕро▓ро░рпНроЯрпН роХрпКроЯрпБродрпНродрпБ роЙро│рпНро│рпЗ ро╡ро┐роЯро▓ро╛роорпН.
            alert("OTP роЪрооро░рпНрокрпНрокро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ. ро▓ро╛роХро┐ройрпН роЪрпЖропрпНропрокрпНрокроЯрпБроХро┐ро▒родрпБ!");
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); }
        function saveSettings() {
            localStorage.setItem('kasu_kandhu_url', document.getElementById('apiUrlInput').value);
            localStorage.setItem('kasu_kandhu_key', document.getElementById('apiKeyInput').value);
            WEB_APP_URL = document.getElementById('apiUrlInput').value;
            SECRET_KEY = document.getElementById('apiKeyInput').value;
            alert("Saved!"); toggleSettings();
        }

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ..."; btn.disabled = true;

            const payload = {
                amount: document.getElementById('amount').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                key: SECRET_KEY
            };

            const query = new URLSearchParams(payload).toString();
            await fetch(`${WEB_APP_URL}?${query}`, { method: 'POST', mode: 'no-cors' });
            alert('тЬЕ ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ!');
            document.getElementById('transactionForm').reset();
            btn.innerText = "роЪрпЗрооро┐"; btn.disabled = false;
        });

        document.getElementById('apiUrlInput').value = WEB_APP_URL;
        document.getElementById('apiKeyInput').value = SECRET_KEY;
    </script>
</body>
</html>
