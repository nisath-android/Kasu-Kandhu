/**
 * Main Engine v8.5.1 - Persistent Theme, Secure Logout & Hourly Trigger Gold Sync
 * தீம் சேமிப்பு, பாதுகாப்பு லாக்அவுட் மற்றும் ஒரு மணி நேரத்திற்கு ஒருமுறை விலையைப் புதுப்பிக்கும் வசதி.
 */
var ss = SpreadsheetApp.getActiveSpreadsheet();

function doGet(e) {
  const params = e.parameter;
  const action = params.action;
  const callback = params.callback; 
  const masterId = params.masterId;
  
  try {
    const masterSS = SpreadsheetApp.openById(masterId);
    const config = getConfig(masterSS, "Config");
    
    if (params.secret !== config.SECRET_KEY) return sendResponse({ status: "Unauthorized" }, callback);

    // 1. Auth & Login (தீம் தகவலுடன்)
    if (action === "login") {
      const usersData = masterSS.getSheetByName("Users").getDataRange().getValues();
      const user = usersData.find(row => row[2] === params.email);
      if (!user) return sendResponse({ status: "Error", msg: "பயனர் இல்லை!" }, callback);
      
      if (String(user[3]) === params.pass) {
        const userSS = SpreadsheetApp.openById(user[4]);
        const userConf = getConfig(userSS, "Config");
        const savedTheme = userConf.THEME_SETTING ? JSON.parse(userConf.THEME_SETTING) : null;
        return sendResponse({ status: "Success", name: user[1], sheetId: user[4], theme: savedTheme }, callback);
      }
      return sendResponse({ status: "Error", msg: "தவறான கடவுச்சொல்!" }, callback);
    }

    // 2. தீம் வண்ணத்தைச் சேமித்தல்
    if (action === "updateTheme") {
      const userSS = SpreadsheetApp.openById(params.sheetId);
      const confSheet = userSS.getSheetByName("Config");
      const data = confSheet.getDataRange().getValues();
      let found = false;
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === "THEME_SETTING") {
          confSheet.getRange(i + 1, 2).setValue(params.themeData);
          found = true; break;
        }
      }
      if (!found) confSheet.appendRow(["THEME_SETTING", params.themeData]);
      return sendResponse({ status: "Success" }, callback);
    }

    // 3. ஆப் தரவுகள் (Cached Gold & Theme Sync)
    if (action === "getAppData") {
      const userSS = SpreadsheetApp.openById(params.sheetId);
      const uConf = getConfig(userSS, "Config");
      const salary = Number(uConf.BASE_SALARY) || 0;
      const theme = uConf.THEME_SETTING ? JSON.parse(uConf.THEME_SETTING) : null;
      
      const targetMonth = (params.month !== undefined && params.month !== "") ? parseInt(params.month) : new Date().getMonth();
      const targetYear = (params.year !== undefined && params.year !== "") ? parseInt(params.year) : new Date().getFullYear();
      
      const loans = getLoansWithStatus(userSS, targetMonth, targetYear);
      const transactions = getRecentTransactions(userSS);
      const masterCategories = getMasterCategoriesFromSheet(userSS);
      
      // v8.5.1: ட்ரிக்கர் மூலம் சேமிக்கப்பட்ட விலைகளை எடுத்து ஆப்பை வேகமாக இயக்குதல்
      const metalRates = getCachedMetalRates(userSS); 
      
      const totalEMI = loans.reduce((s, l) => s + Number(l.amount), 0);
      const deficit = salary - (totalEMI + 10650);
      
      return sendResponse({ 
        status: "Success", salary, loans, transactions, deficit, theme,
        masterCategories, metalRates,
        advice: deficit < 0 ? "நிதி நெருக்கடி! செலவுகளைக் குறைக்கவும்." : "நிதி நிலை சீராக உள்ளது.",
        holidays: calculateHolidays(targetMonth, targetYear) 
      }, callback);
    }

    // --- இதர செயல்பாடுகள் ---
    if (action === "register") {
      const userSheet = masterSS.getSheetByName("Users");
      if (userSheet.getDataRange().getValues().some(row => row[2] === params.email)) {
        return sendResponse({ status: "Error", msg: "மின்னஞ்சல் ஏற்கனவே உள்ளது!" }, callback);
      }
      const newUserSS = SpreadsheetApp.create("K-K User - " + params.name);
      setupUserSheet(newUserSS);
      newUserSS.addEditor(params.email);
      userSheet.appendRow([new Date(), params.name, params.email, params.pass, newUserSS.getId()]);
      return sendResponse({ status: "Success" }, callback);
    }

    if (action === "updateEMIStatus") {
      const userSS = SpreadsheetApp.openById(params.sheetId);
      const statusSheet = userSS.getSheetByName("EMI_Status") || userSS.insertSheet("EMI_Status").appendRow(["Year", "Month", "LoanName", "Status"]);
      const data = statusSheet.getDataRange().getValues();
      let found = false;
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] == params.year && data[i][1] == params.month && data[i][2] == params.loanName) {
          statusSheet.getRange(i + 1, 4).setValue(params.status);
          found = true; break;
        }
      }
      if (!found) statusSheet.appendRow([params.year, params.month, params.loanName, params.status]);
      return sendResponse({ status: "Success" }, callback);
    }

    if (action === "updateLoan") {
      const userSS = SpreadsheetApp.openById(params.sheetId);
      const loanSheet = userSS.getSheetByName("Loan_Master");
      const data = loanSheet.getDataRange().getValues();
      let found = false;
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] === params.loanName) {
          loanSheet.getRange(i + 1, 2).setValue(params.amount);
          loanSheet.getRange(i + 1, 3).setValue(params.dueDate);
          found = true; break;
        }
      }
      if (!found) loanSheet.appendRow([params.loanName, params.amount, params.dueDate]);
      return sendResponse({ status: "Success" }, callback);
    }

    if (action === "updateSalary") {
      const userSS = SpreadsheetApp.openById(params.sheetId);
      const confSheet = userSS.getSheetByName("Config");
      const data = confSheet.getDataRange().getValues();
      let found = false;
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === "BASE_SALARY") { confSheet.getRange(i + 1, 2).setValue(params.amount); found = true; break; }
      }
      if (!found) confSheet.appendRow(["BASE_SALARY", params.amount]);
      return sendResponse({ status: "Success" }, callback);
    }

    if (action === "addTransaction") {
      const userSS = SpreadsheetApp.openById(params.sheetId);
      userSS.getSheetByName("Transactions").appendRow([new Date(), params.category, params.amount, params.note, params.type]);
      return sendResponse({ status: "Success" }, callback);
    }

    if (action === "initSetup") {
      setupUserSheet(SpreadsheetApp.openById(params.sheetId));
      return sendResponse({ status: "Setup Ready" }, callback);
    }

  } catch (err) { return sendResponse({ status: "Error", msg: err.toString() }, callback); }
}

// --- v8.5.1: Hourly Trigger & Cache Functions ---

/**
 * இந்த பங்க்ஷனை ஒரு மணி நேரத்திற்கு ஒருமுறை இயங்க ட்ரிக்கர் (Trigger) செட் செய்யவும்.
 */
function updateLiveRatesCache() {
  const rates = getMetalRatesDirect();
  const userSheets = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Users").getDataRange().getValues().slice(1);
  
  userSheets.forEach(row => {
    try {
      const userSS = SpreadsheetApp.openById(row[4]);
      let cacheSheet = userSS.getSheetByName("Metal_Rates_Cache");
      if (!cacheSheet) {
        cacheSheet = userSS.insertSheet("Metal_Rates_Cache");
        cacheSheet.appendRow(["Last Updated", "22K Gold", "24K Gold", "Silver"]);
      }
      cacheSheet.getRange("A2:D2").setValues([[new Date(), rates.gold22k, rates.gold24k, rates.silver]]);
    } catch (e) { console.log("Cache update failed for a user: " + e.toString()); }
  });
}

/**
 * சேமிக்கப்பட்ட விலைகளை ஸ்பிரட்ஷீட்டில் இருந்து எடுக்கும் முறை.
 */
function getCachedMetalRates(userSS) {
  try {
    let cacheSheet = userSS.getSheetByName("Metal_Rates_Cache");
    if (!cacheSheet) {
      const initialRates = getMetalRatesDirect();
      cacheSheet = userSS.insertSheet("Metal_Rates_Cache");
      cacheSheet.appendRow(["Last Updated", "22K Gold", "24K Gold", "Silver"]);
      cacheSheet.getRange("A2:D2").setValues([[new Date(), initialRates.gold22k, initialRates.gold24k, initialRates.silver]]);
      return initialRates;
    }
    const data = cacheSheet.getRange("B2:D2").getValues()[0];
    return { gold22k: data[0], gold24k: data[1], silver: data[2] };
  } catch (e) {
    return getMetalRatesDirect(); 
  }
}

// --- துல்லியமான விலைத் திரட்டல் (User Provided Code) ---
function getMetalRatesDirect() {
  try {
    const url = "https://www.livechennai.com/gold_silverrate.asp";
    const response = UrlFetchApp.fetch(url, { headers: { "User-Agent": "Mozilla/5.0" }, muteHttpExceptions: true });
    const content = response.getContentText();
    const table1Match = content.match(/<table\s+class="[^"]*table-bordered today-gold-rate[^"]*">([\s\S]*?)<\/table>/i);
    if (!table1Match) throw new Error("T1 Fail");
    const html = table1Match[1];
    const dateMatch = html.match(/\d{1,2}\/\w+\/\d{4}/);
    const gold22Match = html.match(/<i class="fa fa-inr"><\/i>\s*([\d,]+)\s*\(/);
    const silverMatch = html.match(/<i class="fa fa-inr"><\/i>\s*([\d.]+)\s*\(/);
    
    let gold24 = "16014"; 
    const tables = content.split(/<\/table>/i);
    const table2 = tables.find(t => t.includes('Pure Gold (24 k)')) + '</table>';
    if (table2 && dateMatch) {
      const escapedDate = dateMatch[0].replace(/\//g, '\\/');
      const rowMatch = table2.match(new RegExp('<tr[^>]*>([\\s\\S]*?<td[^>]*>' + escapedDate + '<\\/td>[\\s\\S]*?)<\\/tr>', 'i'));
      if (rowMatch) {
        const tdMatches = rowMatch[1].match(/<td[^>]*>([\s\S]*?)<\/td>/gi);
        if (tdMatches && tdMatches.length > 1) {
          const val = tdMatches[1].match(/[\d,]+/);
          if (val) gold24 = val[0].replace(/,/g, '');
        }
      }
    }

    return {
      date: dateMatch ? dateMatch[0] : "Today",
      gold22k: gold22Match ? gold22Match[1].replace(/,/g, '') : "14680",
      gold24k: gold24,
      silver: silverMatch ? silverMatch[1] : "290.00"
    };
  } catch (e) { return { gold22k: "14680", gold24k: "16014", silver: "290.00" }; }
}

// --- இதர அடிப்படை செயல்பாடுகள் ---
function sendResponse(obj, callback) {
  return ContentService.createTextOutput(callback + "(" + JSON.stringify(obj) + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);
}

function getConfig(ss, name) {
  const sheet = ss.getSheetByName(name);
  if (!sheet) return {};
  let conf = {};
  sheet.getDataRange().getValues().forEach(row => { conf[row[0]] = String(row[1]); });
  return conf;
}

function getLoansWithStatus(ss, month, year) {
  const loanSheet = ss.getSheetByName("Loan_Master");
  const statusSheet = ss.getSheetByName("EMI_Status");
  if (!loanSheet) return [];
  const loans = loanSheet.getDataRange().getValues().slice(1);
  const statuses = statusSheet ? statusSheet.getDataRange().getValues().slice(1) : [];
  return loans.map(r => {
    const statusRow = statuses.find(s => s[0] == year && s[1] == month && s[2] == r[0]);
    return { name: r[0], amount: r[1], date: r[2], status: statusRow ? statusRow[3] : "Pending" };
  });
}

function getRecentTransactions(ss) {
  const sheet = ss.getSheetByName("Transactions");
  if (!sheet || sheet.getLastRow() < 2) return [];
  const data = sheet.getRange(Math.max(2, sheet.getLastRow() - 9), 1, Math.min(10, sheet.getLastRow() - 1), 5).getValues();
  return data.reverse().map(r => ({ date: r[0], category: r[1], amount: r[2], note: r[3], type: r[4] }));
}

function getMasterCategoriesFromSheet(ss) {
  let sheet = ss.getSheetByName("Category_Master");
  if (!sheet) return { "EMI": [], "Expenses": [], "Savings": [] };
  const data = sheet.getDataRange().getValues().slice(1);
  const result = {};
  data.forEach(row => { if (row[0]) { if (!result[row[0]]) result[row[0]] = []; if (row[1]) result[row[0]].push(row[1]); } });
  return result;
}

function setupUserSheet(ss) {
  if (!ss.getSheetByName("Transactions")) ss.insertSheet("Transactions").appendRow(["Date", "Category", "Amount", "Note", "Type"]);
  if (!ss.getSheetByName("Config")) ss.insertSheet("Config").appendRow(["Key", "Value"]);
  if (!ss.getSheetByName("Loan_Master")) ss.insertSheet("Loan_Master").appendRow(["Loan Name", "Amount", "Due Date"]);
  if (!ss.getSheetByName("EMI_Status")) ss.insertSheet("EMI_Status").appendRow(["Year", "Month", "LoanName", "Status"]);
}

function calculateHolidays(m, y) {
  const d = new Date(), tm = (m !== null && !isNaN(m)) ? Number(m) : d.getMonth(), ty = (y !== null && !isNaN(y)) ? Number(y) : d.getFullYear(), h = [];
  for (let i = 1; i <= 31; i++) {
    const day = new Date(ty, tm, i);
    if (day.getMonth() !== tm) break;
    if (day.getDay() === 0 || (day.getDay() === 6 && [2, 4, 5].includes(Math.ceil(i / 7)))) h.push(i);
  }
  return h;
}
