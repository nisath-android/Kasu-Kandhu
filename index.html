<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasu-Kandhu | OTP Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ро▓ро╛роХро┐ройрпН ро╕рпНроХро┐ро░рпАройрпН роОрокрпНрокрпЛродрпБроорпН роорпЗро▓рпЗ родрпЖро░ро┐роп роЙро▒рпБродро┐ роЪрпЖропрпНроп */
        #loginPage { z-index: 9999; }
    </style>
</head>
<body class="bg-slate-100 font-sans">

    <div id="loginPage" class="fixed inset-0 bg-indigo-900 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-indigo-700 mb-6 italic">роХро╛роЪрпБ-роХроирпНродрпБ Login</h1>
            
            <div id="urlSetup" class="mb-4 text-left p-3 bg-indigo-50 rounded-xl hidden">
                <p class="text-[10px] font-bold text-indigo-600 mb-1">SET API URL FIRST:</p>
                <input type="text" id="apiUrlInitial" placeholder="Apps Script URL" class="w-full p-2 text-xs border rounded-lg outline-none">
                <button onclick="saveInitialUrl()" class="w-full mt-2 bg-indigo-600 text-white text-xs py-1 rounded-lg">Save Config</button>
            </div>

            <div id="emailStep">
                <input type="email" id="userEmail" placeholder="роЙроЩрпНроХро│рпН рооро┐ройрпНройроЮрпНроЪро▓рпН" class="w-full p-4 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-indigo-500 text-center">
                <button onclick="sendOTP()" id="otpBtn" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200">OTP рокрпЖро▒рпБ (Get OTP)</button>
            </div>

            <div id="otpStep" class="hidden animate-pulse">
                <p class="text-sm text-slate-500 mb-4 font-medium italic">рооро┐ройрпНройроЮрпНроЪро▓ро┐ро▓рпН роЙро│рпНро│ 6 роЗро▓роХрпНроХ роОрогрпНрогрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН</p>
                <input type="number" id="otpInput" placeholder="000000" class="w-full p-4 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-indigo-500 text-center text-2xl font-bold tracking-[10px]">
                <button onclick="verifyOTP()" id="verifyBtn" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-green-200">роЪро░ро┐рокро╛ро░рпН (Verify)</button>
            </div>
            
            <button onclick="document.getElementById('urlSetup').classList.toggle('hidden')" class="mt-6 text-[10px] text-slate-400 uppercase tracking-widest">тЪЩя╕П Config API URL</button>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen">
        <header class="bg-indigo-700 p-5 text-white flex justify-between items-center shadow-lg">
            <h1 class="text-xl font-bold italic tracking-tighter">ЁЯЫбя╕П Kasu-Kandhu Pro</h1>
            <button onclick="logout()" class="text-xs bg-indigo-800 px-3 py-1 rounded-full border border-indigo-400">Logout</button>
        </header>

        <main class="container mx-auto p-6 max-w-md">
            <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100">
                <h2 class="text-xl font-bold mb-6 text-slate-700">рокрпБродро┐роп роЪрпЖро▓ро╡рпБ рокродро┐ро╡рпБ</h2>
                <form id="transactionForm" class="space-y-5">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">родрпКроХрпИ</label>
                        <input type="number" id="amount" placeholder="0.00" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">ро╡роХрпИ</label>
                        <select id="category" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                            <option value="EMI">EMI (роЪро┐ро╡рокрпНрокрпБ)</option>
                            <option value="Expense">роЪрпЖро▓ро╡рпБ (роирпАро▓роорпН)</option>
                            <option value="Savings">роЪрпЗрооро┐рокрпНрокрпБ (рокроЪрпНроЪрпИ)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">ро╡ро┐ро│роХрпНроХроорпН</label>
                        <input type="text" id="description" placeholder="Description" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-bold py-5 rounded-2xl hover:bg-indigo-700 shadow-xl shadow-indigo-100 transition-all active:scale-95">
                        Sheets-ро▓рпН роЪрпЗрооро┐
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script>
        // 1. Initial Logic
        let WEB_APP_URL = localStorage.getItem('kasu_kandhu_url') || "";
        
        function saveInitialUrl() {
            const val = document.getElementById('apiUrlInitial').value.trim();
            if(val) {
                localStorage.setItem('kasu_kandhu_url', val);
                WEB_APP_URL = val;
                alert("API URL роЪрпЖроЯрпН роЪрпЖропрпНропрокрпНрокроЯрпНроЯродрпБ!");
                document.getElementById('urlSetup').classList.add('hidden');
            }
        }

        // 2. OTP Logic
        async function sendOTP() {
            if(!WEB_APP_URL) { 
                alert("API URL роХро╛ро▓ро┐ропро╛роХ роЙро│рпНро│родрпБ! роХрпАро┤рпЗ роЙро│рпНро│ тЪЩя╕П роХрпБро▒ро┐ропрпАроЯрпНроЯрпИ роЕро┤рпБродрпНродро┐ URL-роР роЙро│рпНро│ро┐роЯро╡рпБроорпН."); 
                return; 
            }
            const email = document.getElementById('userEmail').value;
            if(!email) { alert("рооро┐ройрпНройроЮрпНроЪро▓рпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН!"); return; }

            const btn = document.getElementById('otpBtn');
            btn.innerText = "OTP роЕройрпБрокрпНрокрокрпНрокроЯрпБроХро┐ро▒родрпБ...";
            btn.disabled = true;

            try {
                const res = await fetch(`${WEB_APP_URL}?action=sendOTP&email=${email}`);
                const text = await res.text();
                
                if (text.includes("Sent")) {
                    document.getElementById('emailStep').classList.add('hidden');
                    document.getElementById('otpStep').classList.remove('hidden');
                    alert("OTP роЙроЩрпНроХро│рпН рооро┐ройрпНройроЮрпНроЪро▓рпБроХрпНроХрпБ роЕройрпБрокрпНрокрокрпНрокроЯрпНроЯродрпБ!");
                } else {
                    alert("роЕройрпБроородро┐ рооро▒рпБроХрпНроХрокрпНрокроЯрпНроЯродрпБ роЕро▓рпНро▓родрпБ рокро┐ро┤рпИ! (ро╖рпАроЯрпНроЯро┐ро▓рпН роЙроЩрпНроХро│рпН роорпЖропро┐ро▓рпН роЙро│рпНро│родро╛ роОройрокрпН рокро╛ро░рпНроХрпНроХро╡рпБроорпН)");
                    btn.innerText = "OTP рокрпЖро▒рпБ (Get OTP)";
                    btn.disabled = false;
                }
            } catch (err) {
                alert("API Error! роЙроЩрпНроХро│рпН URL роЪро░ро┐ропро╛роХ роЙро│рпНро│родро╛ роОройрокрпН рокро╛ро░рпНроХрпНроХро╡рпБроорпН.");
                btn.innerText = "OTP рокрпЖро▒рпБ (Get OTP)";
                btn.disabled = false;
            }
        }

        async function verifyOTP() {
            const otp = document.getElementById('otpInput').value;
            if(!otp) return;
            
            const btn = document.getElementById('verifyBtn');
            btn.innerText = "роЪро░ро┐рокро╛ро░рпНроХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ...";

            // POST роорпБро▒рпИропро┐ро▓рпН OTP роЪро░ро┐рокро╛ро░рпНродрпНродро▓рпН
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: "verifyOTP", otp: otp })
                });
                
                // GAS-ро▓рпН no-cors роорпВро▓роорпН Response рокроЯро┐роХрпНроХ роорпБроЯро┐ропро╛родрпБ роОройрпНрокродро╛ро▓рпН, роТро░рпБ роЪро┐ро▒ро┐роп родро╛роородродрпНродро┐ро▒рпНроХрпБ рокро┐ройрпН роЙро│рпНро│рпЗ ро╡ро┐роЯрпБроХро┐ро▒рпЛроорпН
                setTimeout(() => {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                }, 1000);
            } catch (e) {
                alert("родро╡ро▒ро╛рой OTP!");
                btn.innerText = "роЪро░ро┐рокро╛ро░рпН (Verify)";
            }
        }

        // 3. Transaction Logic
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ..."; btn.disabled = true;

            const payload = {
                amount: document.getElementById('amount').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                key: localStorage.getItem('kasu_kandhu_key') || "MyPrivateApp123" // Default key or custom
            };

            try {
                const query = new URLSearchParams(payload).toString();
                await fetch(`${WEB_APP_URL}?${query}`, { method: 'POST', mode: 'no-cors' });
                alert('тЬЕ ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ!');
                document.getElementById('transactionForm').reset();
            } catch (e) {
                alert('тЭМ рокро┐ро┤рпИ!');
            } finally {
                btn.innerText = "Sheets-ро▓рпН роЪрпЗрооро┐"; btn.disabled = false;
            }
        });

        function logout() {
            location.reload();
        }
    </script>
</body>
</html>
