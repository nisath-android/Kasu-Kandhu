<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasu-Kandhu v4.1 | Multi-Screen Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .no-select { user-select: none; }
        .screen { display: none; animation: fadeIn 0.3s ease-in-out; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Active Nav Styling */
        .active-nav { color: #4f46e5; border-top: 2px solid #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 no-select font-sans pb-20">

    <div id="sideNav" class="fixed inset-y-0 left-0 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 z-[10000]">
        <div class="p-6">
            <h1 class="text-2xl font-black text-indigo-700 italic mb-8">роорпЖройрпБ</h1>
            <nav class="space-y-4">
                <button onclick="changeScreen('home')" class="w-full text-left p-3 hover:bg-slate-100 rounded-xl font-bold flex items-center gap-3">ЁЯПа роорпБроХрокрпНрокрпБ</button>
                <button onclick="changeScreen('history')" class="w-full text-left p-3 hover:bg-slate-100 rounded-xl font-bold flex items-center gap-3">ЁЯУЬ ро╡ро░ро▓ро╛ро▒рпБ</button>
                <button onclick="changeScreen('settings')" class="w-full text-left p-3 hover:bg-slate-100 rounded-xl font-bold flex items-center gap-3">тЪЩя╕П роЕроорпИрокрпНрокрпБроХро│рпН</button>
                <hr>
                <button onclick="location.reload()" class="w-full text-left p-3 text-red-500 font-bold flex items-center gap-3">ЁЯЪк ро╡рпЖро│ро┐ропрпЗро▒рпБ</button>
            </nav>
        </div>
    </div>
    <div id="navOverlay" onclick="toggleSideNav()" class="fixed inset-0 bg-black/50 hidden z-[9999]"></div>

    <header class="bg-white p-4 shadow-sm border-b flex justify-between items-center sticky top-0 z-[50]">
        <button onclick="toggleSideNav()" class="p-2 text-xl">тШ░</button>
        <h1 id="topBarTitle" class="font-black text-slate-800 italic uppercase">роорпБроХрокрпНрокрпБ</h1>
        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold">N</div>
    </header>

    <div id="loginPage" class="fixed inset-0 bg-slate-900 flex items-center justify-center p-4 z-[99999]">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-3xl font-black text-indigo-700 italic mb-10 uppercase">роХро╛роЪрпБ-роХроирпНродрпБ</h1>
            <div id="emailStep">
                <input type="email" id="userEmail" placeholder="рооро┐ройрпНройроЮрпНроЪро▓рпН" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 text-center">
                <button onclick="sendOTP()" id="otpBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">OTP роЕройрпБрокрпНрокрпБ</button>
            </div>
            <div id="otpStep" class="hidden">
                <input type="number" id="otpInput" placeholder="000000" class="w-full p-4 border rounded-2xl mb-4 text-center text-2xl font-black tracking-[10px]">
                <button onclick="verifyOTP()" id="verifyBtn" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold">роЙро│рпНроирпБро┤рпИ</button>
            </div>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-md">
        
        <div id="homeScreen" class="screen active-screen space-y-6">
            <div class="bg-indigo-600 p-8 rounded-[2.5rem] text-white shadow-xl">
                <p class="text-indigo-100 text-sm">роЗроирпНрод рооро╛род роЪрпЖро▓ро╡рпБ</p>
                <h2 id="totalExpenseDisplay" class="text-4xl font-black mt-1 tracking-tighter">тВ╣ 0</h2>
                <div class="mt-4 flex gap-4 text-[10px] font-bold uppercase">
                    <span id="emiStats" class="bg-white/20 px-3 py-1 rounded-full">EMI: тВ╣0</span>
                    <span id="savingsStats" class="bg-white/20 px-3 py-1 rounded-full">роЪрпЗрооро┐рокрпНрокрпБ: тВ╣0</span>
                </div>
            </div>
            <div class="bg-white p-6 rounded-[2.5rem] shadow-lg border border-slate-100">
                <canvas id="expenseChart" class="max-h-[250px]"></canvas>
            </div>
            <div class="bg-white p-6 rounded-[2.5rem] shadow-lg border border-slate-100">
                <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase">рокрпБродро┐роп рокродро┐ро╡рпБ</h3>
                <form id="transactionForm" class="space-y-4">
                    <input type="number" id="amount" placeholder="родрпКроХрпИ тВ╣" class="w-full p-4 bg-slate-50 rounded-2xl text-xl font-bold outline-none border">
                    <select id="category" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border">
                        <option value="EMI">EMI</option>
                        <option value="Expense">роЪрпЖро▓ро╡рпБ</option>
                        <option value="Savings">роЪрпЗрооро┐рокрпНрокрпБ</option>
                    </select>
                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">Sheets-ро▓рпН роЪрпЗрооро┐</button>
                </form>
            </div>
        </div>

        <div id="historyScreen" class="screen space-y-4 text-center p-10">
            <img src="https://cdn-icons-png.flaticon.com/512/2644/2644831.png" class="w-20 mx-auto opacity-20">
            <h2 class="text-xl font-bold text-slate-400">ро╡ро░ро▓ро╛ро▒рпБ рокроХрпНроХроорпН родропро╛ро░рпН роиро┐ро▓рпИропро┐ро▓рпН роЙро│рпНро│родрпБ...</h2>
            <p class="text-xs text-slate-300">роЗроЩрпНроХрпЗ роЙроЩрпНроХро│рпН роорпБроирпНродрпИроп роЪрпЖро▓ро╡рпБроХро│рпН рокроЯрпНроЯро┐ропро▓ро┐роЯрокрпНрокроЯрпБроорпН.</p>
        </div>

        <div id="settingsScreen" class="screen space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-md border border-slate-100">
                <h3 class="font-bold mb-4">API Configuration</h3>
                <input type="text" id="apiUrlInitial" placeholder="Apps Script URL" class="w-full p-3 bg-slate-50 border rounded-xl text-xs outline-none mb-3">
                <input type="password" id="apiKeyInitial" placeholder="Secret Key" class="w-full p-3 bg-slate-50 border rounded-xl text-xs outline-none mb-4">
                <button onclick="saveInitialConfig()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-xs uppercase tracking-widest">Update Settings</button>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-slate-200 flex justify-around p-3 z-50">
        <button onclick="changeScreen('home')" id="nav-home" class="flex flex-col items-center gap-1 active-nav flex-1">
            <span class="text-xl">ЁЯПа</span>
            <span class="text-[10px] font-bold">Home</span>
        </button>
        <button onclick="changeScreen('history')" id="nav-history" class="flex flex-col items-center gap-1 flex-1">
            <span class="text-xl">ЁЯУЬ</span>
            <span class="text-[10px] font-bold">History</span>
        </button>
        <button onclick="changeScreen('settings')" id="nav-settings" class="flex flex-col items-center gap-1 flex-1">
            <span class="text-xl">тЪЩя╕П</span>
            <span class="text-[10px] font-bold">Settings</span>
        </button>
    </nav>

    <script>
        let WEB_APP_URL = localStorage.getItem('k_url') || "";
        let SESSION_TOKEN = "";
        let myChart = null;

        // --- NAVIGATION LOGIC ---
        function changeScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            // Remove active nav styling
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
            
            // Show target screen
            document.getElementById(screenId + 'Screen').classList.add('active-screen');
            document.getElementById('nav-' + screenId).classList.add('active-nav');
            
            // Update Top Bar Title
            const titles = { 'home': 'роорпБроХрокрпНрокрпБ', 'history': 'ро╡ро░ро▓ро╛ро▒рпБ', 'settings': 'роЕроорпИрокрпНрокрпБроХро│рпН' };
            document.getElementById('topBarTitle').innerText = titles[screenId];
            
            if(screenId === 'home') loadDashboard();
            if(window.sideNavOpen) toggleSideNav();
        }

        function toggleSideNav() {
            const nav = document.getElementById('sideNav');
            const overlay = document.getElementById('navOverlay');
            if(window.sideNavOpen) {
                nav.style.transform = 'translateX(-100%)';
                overlay.classList.add('hidden');
            } else {
                nav.style.transform = 'translateX(0)';
                overlay.classList.remove('hidden');
            }
            window.sideNavOpen = !window.sideNavOpen;
        }

        // API & Auth Logic (As per v4.0.0)
        async function jsonpFetch(params) {
            return new Promise(resolve => {
                const cb = 'cb_' + Math.round(100000 * Math.random());
                window[cb] = (d) => { resolve(d); delete window[cb]; document.body.removeChild(s); };
                const s = document.createElement('script');
                s.src = `${WEB_APP_URL}?callback=${cb}&${new URLSearchParams(params).toString()}`;
                document.body.appendChild(s);
            });
        }

        async function sendOTP() {
            const res = await jsonpFetch({ action: "sendOTP", email: document.getElementById('userEmail').value });
            if(res.status === "Sent") {
                document.getElementById('emailStep').classList.add('hidden');
                document.getElementById('otpStep').classList.remove('hidden');
            } else { alert("роЕройрпБроородро┐ рооро▒рпБроХрпНроХрокрпНрокроЯрпНроЯродрпБ!"); }
        }

        async function verifyOTP() {
            const res = await jsonpFetch({ action: "verifyOTP", otp: document.getElementById('otpInput').value });
            if(res.status === "Success") {
                SESSION_TOKEN = res.token;
                document.getElementById('loginPage').classList.add('hidden');
                loadDashboard();
            } else { alert("родро╡ро▒ро╛рой OTP!"); }
        }

        async function loadDashboard() {
            const data = await jsonpFetch({ action: "getDashboardData" });
            document.getElementById('totalExpenseDisplay').innerText = `тВ╣ ${data.Total.toLocaleString('en-IN')}`;
            document.getElementById('emiStats').innerText = `EMI: тВ╣${data.EMI}`;
            document.getElementById('savingsStats').innerText = `роЪрпЗрооро┐рокрпНрокрпБ: тВ╣${data.Savings}`;

            const ctx = document.getElementById('expenseChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['EMI', 'Expense', 'Savings'],
                    datasets: [{
                        data: [data.EMI, data.Expense, data.Savings],
                        backgroundColor: ['#4f46e5', '#fbbf24', '#10b981'],
                        borderWidth: 8,
                        borderColor: '#ffffff'
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } }, cutout: '75%' }
            });
        }

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn'); btn.disabled = true;
            const q = new URLSearchParams({
                amount: document.getElementById('amount').value,
                category: document.getElementById('category').value,
                token: SESSION_TOKEN,
                key: localStorage.getItem('k_key')
            }).toString();

            await fetch(`${WEB_APP_URL}?${q}`, { method: 'POST', mode: 'no-cors' });
            alert("тЬЕ роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ!");
            document.getElementById('transactionForm').reset();
            btn.disabled = false;
            loadDashboard();
        });

        function saveInitialConfig() {
            localStorage.setItem('k_url', document.getElementById('apiUrlInitial').value.trim());
            localStorage.setItem('k_key', document.getElementById('apiKeyInitial').value.trim());
            alert("Settings Updated!");
            location.reload();
        }

        document.getElementById('apiUrlInitial').value = WEB_APP_URL;
        document.getElementById('apiKeyInitial').value = localStorage.getItem('k_key');
    </script>
</body>
</html>
