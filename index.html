<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>காசு-கந்து PRO v9.5.7.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style id="dynamic-theme">
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Serif+Tamil:wght@400;700&display=swap');
        :root { --primary-color: #6366f1; --bg-color: #fcfdfe; --text-color: #1e293b; --card-radius: 28px; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: all 0.3s; overflow-x: hidden; }
        .theme-primary { background: linear-gradient(135deg, var(--primary-color) 0%, #4f46e5 100%); }
        .theme-card { background: white; border-radius: var(--card-radius); border: 1px solid #f1f5f9; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); }
        #splash { position: fixed; inset: 0; background: white; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .progress-bar { width: 240px; height: 8px; background: #f1f5f9; border-radius: 10px; overflow: hidden; margin-top: 30px; }
        .progress-fill { width: 0%; height: 100%; background: var(--primary-color); transition: 0.4s; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .cal-day { min-height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-weight: 600; }
        .emi-date { background: var(--primary-color) !important; color: white !important; }
        .syncing-active .dot { animation: pulse 1.5s infinite; opacity: 1; }
        @keyframes pulse { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(0.8); opacity: 0.5; } }
        #dashboard { display: none; }
        .screen { display: none; } .screen.active { display: block; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #e2e8f0; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>
<body class="antialiased hide-scrollbar">

    <!-- Splash Screen -->
    <div id="splash">
        <h1 class="text-4xl font-black italic" style="color:var(--primary-color)">காசு-கந்து</h1>
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        <p id="progress-text" class="mt-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">தயார் செய்யப்படுகிறது... 0%</p>
    </div>

    <!-- Init View -->
    <div id="init-view" class="h-screen flex flex-col bg-slate-50 overflow-y-auto">
        <div class="flex-1 flex items-center justify-center p-6">
            <div id="auth-panel" class="w-full max-w-sm bg-white p-10 rounded-[3rem] shadow-xl text-center">
                
                <!-- Login Screen -->
                <div id="auth-login" class="screen active">
                    <h2 class="text-3xl font-black mb-10 italic">உள்நுழைக</h2>
                    <input type="email" id="loginEmail" placeholder="மின்னஞ்சல்" class="w-full p-5 bg-slate-50 rounded-2xl mb-4 outline-none font-bold shadow-inner">
                    <input type="password" id="loginPass" placeholder="கடவுச்சொல்" class="w-full p-5 bg-slate-50 rounded-2xl mb-6 outline-none font-bold shadow-inner">
                    <button onclick="loginUser()" id="btn-login" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg">உள்நுழைக</button>
                    <div class="mt-6 space-y-3">
                        <button onclick="toggleAuth('register')" class="text-[10px] font-bold text-indigo-500 uppercase underline block mx-auto">புதிய கணக்கு தொடங்க</button>
                        <button onclick="requestOTP()" class="text-[10px] font-bold text-slate-400 uppercase underline block mx-auto">OTP மூலம் நுழைய</button>
                    </div>
                </div>

                <!-- Register Screen -->
                <div id="auth-register" class="screen">
                    <h2 class="text-3xl font-black mb-8 italic">பதிவு செய்க</h2>
                    <input type="text" id="regName" placeholder="முழு பெயர்" class="w-full p-5 bg-slate-50 rounded-2xl mb-4 outline-none font-bold shadow-inner">
                    <input type="email" id="regEmail" placeholder="மின்னஞ்சல்" class="w-full p-5 bg-slate-50 rounded-2xl mb-4 outline-none font-bold shadow-inner">
                    <input type="password" id="regPass" placeholder="கடவுச்சொல்" class="w-full p-5 bg-slate-50 rounded-2xl mb-6 outline-none font-bold shadow-inner">
                    <button onclick="registerAccount()" id="btn-reg" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg">பதிவு செய்</button>
                    <button onclick="toggleAuth('login')" class="mt-6 text-[10px] font-bold text-slate-400 uppercase underline block mx-auto">ஏற்கனவே கணக்கு உள்ளது</button>
                </div>
            </div>
        </div>
        <div class="p-6 border-t bg-white">
            <input type="text" id="gUrlInput" placeholder="Gateway URL" class="w-full p-4 text-[10px] border-none rounded-xl bg-slate-100 shadow-inner mb-2 outline-none">
            <button onclick="saveGateway()" class="w-full py-3 bg-slate-200 text-[10px] font-black rounded-xl uppercase hover:bg-slate-300 transition-all">Gateway இணைக்கவும்</button>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="pb-32">
        <header class="bg-white border-b sticky top-0 z-[100] p-6 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-2xl overflow-hidden border-2 border-white shadow-md bg-slate-100">
                    <img id="userAvatar" src="" class="w-full h-full object-cover">
                </div>
                <div>
                    <h1 id="userNameUI" class="text-sm font-black italic">பயனர்</h1>
                    <div class="flex items-center gap-1.5 mt-1">
                        <div id="syncIndicator" class="w-1.5 h-1.5 rounded-full bg-indigo-500 opacity-0 dot"></div>
                        <span id="liveClock" class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">00:00:00 AM</span>
                    </div>
                </div>
            </div>
            <button onclick="logout()" class="w-10 h-10 bg-rose-50 text-rose-500 rounded-xl flex items-center justify-center shadow-sm active:scale-90 transition-transform"><i class="fa-solid fa-power-off"></i></button>
        </header>

        <main class="p-5 space-y-6 max-w-md mx-auto">
            <!-- Metal Rate Card -->
            <div class="theme-card p-6 border-none">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div><p class="text-[8px] font-black text-slate-400 uppercase mb-2">22K தங்கம்</p><p class="text-sm font-black text-indigo-600">₹<span id="rate22k">0</span></p></div>
                    <div class="border-x"><p class="text-[8px] font-black text-slate-400 uppercase mb-2">24K தங்கம்</p><p class="text-sm font-black text-slate-800">₹<span id="rate24k">0</span></p></div>
                    <div><p class="text-[8px] font-black text-slate-400 uppercase mb-2">வெள்ளி</p><p class="text-sm font-black text-blue-600">₹<span id="rateSilver">0</span></p></div>
                </div>
                <div class="mt-4 pt-3 border-t flex justify-between items-center">
                    <span id="goldStatus" class="text-[7px] font-black uppercase text-emerald-500">● நேரலை</span>
                    <span id="metalTs" class="text-[7px] font-black text-slate-300 uppercase">--</span>
                </div>
            </div>

            <!-- Balance Card -->
            <div onclick="showSalaryModal()" class="theme-primary p-10 rounded-[3.5rem] text-white shadow-2xl relative cursor-pointer overflow-hidden active:scale-[0.98] transition-all">
                <p class="text-[10px] font-black uppercase opacity-70 tracking-widest">மாதாந்திர சம்பளம்</p>
                <h2 id="dispSalary" class="text-5xl font-black my-2 tracking-tighter leading-tight">₹0</h2>
                <div id="deficitTag" class="mt-8 inline-block px-4 py-1.5 text-[9px] font-black rounded-full uppercase bg-white/20 shadow-sm">கணக்கிடப்படுகிறது...</div>
            </div>

            <!-- Calendar -->
            <div class="theme-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="text-center"><p id="calMonth" class="text-lg font-black italic leading-none">Month</p><p id="calYear" class="text-[9px] font-bold text-slate-300 uppercase mt-1">Year</p></div>
                    <button onclick="changeMonth(1)" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div id="calGrid" class="grid grid-cols-7 gap-2"></div>
            </div>

            <!-- EMI List -->
            <div id="loanList" class="space-y-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 italic">EMI & சேமிப்புகள்</h3>
                <div id="loanItems" class="space-y-3"></div>
            </div>

            <!-- Transaction List -->
            <div id="transSection" class="space-y-4 pb-12">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 italic">சமீபத்திய வரவு செலவு</h3>
                <div id="transList" class="space-y-3"></div>
            </div>
        </main>

        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t p-8 rounded-t-[3.5rem] flex justify-between items-center shadow-[0_-10px_30px_rgba(0,0,0,0.05)] z-[100]">
            <i class="fa-solid fa-house text-2xl text-indigo-500"></i>
            <div onclick="showAddModal()" class="w-16 h-16 theme-primary text-white rounded-3xl -mt-16 border-8 border-white flex items-center justify-center shadow-xl cursor-pointer active:scale-90 transition-transform"><i class="fa-solid fa-plus text-2xl"></i></div>
            <i class="fa-solid fa-gear text-2xl text-slate-300 cursor-pointer" onclick="initAppDB()"></i>
        </footer>
    </div>

    <!-- Modals -->
    <div id="transModal" class="modal-overlay">
        <div class="bg-white w-full max-w-sm p-10 rounded-[4rem] shadow-2xl">
            <h3 class="text-xl font-black mb-8 italic text-center">புதிய பதிவு</h3>
            <div class="flex gap-2 mb-8 p-1.5 bg-slate-50 rounded-2xl">
                <button onclick="setT('Expense')" id="tE" class="flex-1 py-3 rounded-xl font-bold text-[10px] bg-white text-rose-500 shadow-sm uppercase transition-all">செலவு</button>
                <button onclick="setT('Income')" id="tI" class="flex-1 py-3 rounded-xl font-bold text-[10px] text-slate-400 uppercase transition-all">வரவு</button>
            </div>
            <div class="space-y-6">
                <input type="text" id="tCat" placeholder="வகைப்பாடு" class="w-full p-5 bg-slate-50 rounded-2xl outline-none font-bold shadow-inner">
                <input type="number" id="tAmt" placeholder="தொகை ₹" class="w-full p-5 bg-slate-50 rounded-2xl outline-none text-2xl font-black shadow-inner">
                <button onclick="saveTransaction()" id="btn-save-t" class="w-full theme-primary text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all">பதிவு செய்</button>
                <button onclick="closeModals()" class="w-full py-2 text-[10px] font-bold text-slate-300 uppercase underline">ரத்து</button>
            </div>
        </div>
    </div>

    <script>
        let G_URL = localStorage.getItem('kk_g'), session = null, transType = 'Expense', poller = null;
        let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();

        window.onload = () => {
            updateLiveTime(); setInterval(updateLiveTime, 1000);
            
            // Safety Check: 15 வினாடியில் லோடிங் ஆகாவிட்டால் தானாக தடையை நீக்கும்
            setTimeout(() => { if(document.getElementById('splash')) hideSplash(); }, 15000);

            if(G_URL) {
                const s = localStorage.getItem('kk_session');
                if(s && s !== "undefined" && s !== "null") {
                    try {
                        session = JSON.parse(s);
                        if(session && session.sheetId) {
                            updateProgress(40, "உறுப்பினர் சரிபார்க்கப்படுகிறார்...");
                            enterDashboard(true);
                        } else { hideSplash(); }
                    } catch(e) { hideSplash(); }
                } else hideSplash();
            } else hideSplash();
        };

        // --- Core UI Functions ---
        function updateAvatarUI() {
            if(!session) return;
            const av = document.getElementById('userAvatar');
            if(av) {
                av.src = session.photo || `https://ui-avatars.com/api/?name=${session.name || 'U'}&background=6366f1&color=fff`;
            }
            const nameUI = document.getElementById('userNameUI');
            if(nameUI) {
                nameUI.innerText = session.name || "பயனர்";
            }
        }

        function toggleAuth(s) {
            document.querySelectorAll('.screen').forEach(sc => sc.classList.remove('active'));
            const target = document.getElementById('auth-' + s);
            if(target) target.classList.add('active');
        }

        function updateProgress(p, m) { 
            const fill = document.getElementById('progress-fill');
            const text = document.getElementById('progress-text');
            if(fill) fill.style.width = p+'%'; 
            if(text) text.innerText = m+' '+p+'%'; 
        }

        function hideSplash() { 
            const s = document.getElementById('splash'); 
            if(s) { s.style.opacity='0'; setTimeout(()=> { if(s.parentNode) s.remove(); }, 500); } 
        }

        // --- Network Logic ---
        async function call(p, cb) {
            if(!G_URL) return;
            const n = 'cb'+Date.now();
            window[n] = (res) => { cb(res); delete window[n]; const s = document.getElementById(n); if(s) s.remove(); };
            const s = document.createElement('script'); s.id = n;
            s.src = `${G_URL}${G_URL.includes('?')?'&':'?'}callback=${n}&${new URLSearchParams(p).toString()}`;
            s.onerror = () => { console.error("Network Error"); hideSplash(); };
            document.body.appendChild(s);
        }

        // --- Auth Actions ---
        function loginUser() {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
            if(!e || !p) return alert("விவரங்கள் தேவை!");
            toggleBtn('btn-login', true);
            call({ action: 'login', email: e, pass: p }, (res) => {
                toggleBtn('btn-login', false);
                if(res.status === "Success") {
                    session = res; localStorage.setItem('kk_session', JSON.stringify(res));
                    enterDashboard();
                } else alert(res.msg);
            });
        }

        function registerAccount() {
            const n = document.getElementById('regName').value, e = document.getElementById('regEmail').value, p = document.getElementById('regPass').value;
            if(!n || !e || !p) return alert("அனைத்து விவரங்களும் தேவை!");
            toggleBtn('btn-reg', true);
            call({ action: 'register', name: n, email: e, pass: p }, (res) => {
                toggleBtn('btn-reg', false);
                if(res.status === "Success") {
                    alert("பதிவு வெற்றி! இப்போது லாகின் செய்யவும்.");
                    toggleAuth('login');
                } else alert(res.msg);
            });
        }

        function enterDashboard(skip = false) {
            const init = document.getElementById('init-view');
            const dash = document.getElementById('dashboard');
            if(init) init.style.display = 'none';
            if(dash) dash.style.display = 'block';
            
            updateAvatarUI(); // Fixed function
            loadData();
            startPoller();
        }

        // --- Data Handling ---
        function loadData() {
            if(!session || !session.sheetId) return;
            updateProgress(60, "நிதியியல் தரவுகள் பெறப்படுகின்றன...");
            call({ action: 'getAppData', sheetId: session.sheetId, month: calMonth, year: calYear }, (data) => {
                if(data.status !== "Success") return hideSplash();
                
                // Rates
                const r = data.metalRates || {};
                document.getElementById('rate22k').innerText = r.gold22k || "0";
                document.getElementById('rate24k').innerText = r.gold24k || "0";
                document.getElementById('rateSilver').innerText = r.silver || "0";
                document.getElementById('metalTs').innerText = r.time ? `${r.day}, ${r.time}` : "--";
                
                // Dashboard
                document.getElementById('dispSalary').innerText = `₹${Number(data.salary || 0).toLocaleString()}`;
                const dTag = document.getElementById('deficitTag');
                if(dTag) {
                    dTag.innerText = data.deficit < 0 ? `குறைவு: ₹${Math.abs(data.deficit).toLocaleString()}` : `மீதி: ₹${(data.deficit || 0).toLocaleString()}`;
                    dTag.style.background = data.deficit < 0 ? '#ef4444' : 'rgba(255,255,255,0.2)';
                }

                renderCalendar(data);
                renderLoans(data.loans || []);
                renderTransactions(data.transactions || []);
                
                updateProgress(100, "வெற்றி!");
                setTimeout(hideSplash, 600);
            });
        }

        function startPoller() {
            if(poller) clearInterval(poller);
            poller = setInterval(silentSync, 300000); // 5 Mins
        }

        function silentSync() {
            const ind = document.getElementById('syncIndicator');
            if(ind) ind.parentElement.classList.add('syncing-active');
            call({ action: 'getAppData', sheetId: session.sheetId, month: calMonth, year: calYear }, (data) => {
                if(data.status === "Success") {
                    document.getElementById('rate22k').innerText = data.metalRates.gold22k;
                    document.getElementById('rate24k').innerText = data.metalRates.gold24k;
                    document.getElementById('rateSilver').innerText = data.metalRates.silver;
                    renderTransactions(data.transactions || []);
                }
                if(ind) setTimeout(() => ind.parentElement.classList.remove('syncing-active'), 2000);
            });
        }

        // --- Rendering ---
        function renderCalendar(data) {
            const grid = document.getElementById('calGrid'), names = ["ஜன", "பிப்", "மார்", "ஏப்", "மே", "ஜூன்", "ஜூலை", "ஆக", "செப்", "அக்", "நவ", "டிச"];
            document.getElementById('calMonth').innerText = names[calMonth];
            document.getElementById('calYear').innerText = calYear;
            grid.innerHTML = "";
            const fDay = new Date(calYear, calMonth, 1).getDay(), dInM = new Date(calYear, calMonth + 1, 0).getDate();
            for(let i=0; i<fDay; i++) grid.innerHTML += '<div></div>';
            for(let i=1; i<=dInM; i++) {
                const loan = (data.loans || []).find(l => Number(l.date) === i);
                grid.innerHTML += `<div class="cal-day ${loan?'emi-date':'bg-slate-50 text-slate-400'}">${i}</div>`;
            }
        }

        function renderLoans(loans) {
            const items = document.getElementById('loanItems'); if(!items) return;
            items.innerHTML = loans.length ? "" : "<p class='text-center text-slate-300 py-4 font-bold text-[10px] uppercase'>தகவல்கள் இல்லை</p>";
            loans.forEach(l => {
                const isPaid = l.status === 'Paid';
                items.innerHTML += `<div class="theme-card p-4 flex justify-between items-center ${isPaid?'bg-emerald-50 opacity-70':'bg-white'}">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center font-black ${isPaid?'bg-emerald-100 text-emerald-600':'bg-rose-50 text-rose-500'}">${l.date}</div>
                        <div><h4 class="text-sm font-black">${l.name}</h4><p class="text-[9px] font-bold text-slate-400 uppercase">₹${Number(l.amount).toLocaleString()}</p></div>
                    </div>
                    <label class="switch"><input type="checkbox" ${isPaid?'checked':''} onchange="toggleEMI('${l.name}', this.checked)"><span class="slider"></span></label>
                </div>`;
            });
        }

        function renderTransactions(t) {
            const list = document.getElementById('transList'); if(!list) return;
            list.innerHTML = t.length ? "" : "<p class='text-center text-slate-200 py-6 font-bold text-[10px] uppercase'>பதிவுகள் இல்லை</p>";
            t.forEach(item => {
                const isE = item.type === 'Expense';
                list.innerHTML += `<div class="theme-card p-4 flex justify-between items-center border-none shadow-none bg-slate-50/50">
                    <div><h4 class="text-sm font-black">${item.category}</h4><p class="text-[8px] font-bold text-slate-300 uppercase">${item.date}</p></div>
                    <p class="text-sm font-black ${isE?'text-rose-500':'text-emerald-500'}">${isE?'-':'+'}₹${Number(item.amount).toLocaleString()}</p>
                </div>`;
            });
        }

        // --- Actions ---
        function saveTransaction() {
            const a = document.getElementById('tAmt').value, c = document.getElementById('tCat').value;
            if(!a || !c) return alert("விவரங்கள் தேவை!");
            toggleBtn('btn-save-t', true);
            call({ action: 'addTransaction', amount: a, category: c, type: transType, sheetId: session.sheetId }, (res) => {
                toggleBtn('btn-save-t', false);
                if(res.status === "Success") { closeModals(); loadData(); }
            });
        }

        function toggleEMI(n, c) {
            call({ action: 'updateEMIStatus', loanName: n, status: c?'Paid':'Pending', month: calMonth, year: calYear, sheetId: session.sheetId }, () => loadData());
        }

        // --- Helpers ---
        function saveGateway() { const u = document.getElementById('gUrlInput').value.trim(); if(u.includes('/exec')) { localStorage.setItem('kk_g', u); G_URL = u; location.reload(); } else { alert("தவறான URL!"); } }
        function logout() { if(confirm("வெளியேறவா?")) { localStorage.clear(); location.reload(); } }
        function showAddModal() { document.getElementById('transModal').style.display='flex'; }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
        function toggleBtn(id, l) { const b = document.getElementById(id); if(!b) return; b.disabled = l; if(l) { b.dataset.label = b.innerHTML; b.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; } else { b.innerHTML = b.dataset.label || "சேமி"; } }
        function setT(t) { transType = t; document.getElementById('tE').className = t==='Expense'?'flex-1 py-3 rounded-xl font-bold text-[10px] bg-white text-rose-500 shadow-sm uppercase':'flex-1 py-3 rounded-xl font-bold text-[10px] text-slate-400 uppercase'; document.getElementById('tI').className = t==='Income'?'flex-1 py-3 rounded-xl font-bold text-[10px] bg-white text-emerald-500 shadow-sm uppercase':'flex-1 py-3 rounded-xl font-bold text-[10px] text-slate-400 uppercase'; }
        function updateLiveTime() { const n = new Date(); const clock = document.getElementById('liveClock'); if(clock) clock.innerText = n.toLocaleTimeString('ta-IN'); }
        function changeMonth(o) { calMonth += o; if(calMonth>11){calMonth=0;calYear++;} if(calMonth<0){calMonth=11;calYear--;} loadData(); }
        function initAppDB() { if(confirm("ஆப் தரவுத்தளத்தை தயார் செய்யவா?")) { call({ action: 'initSetup', sheetId: session.sheetId }, (res) => alert(res.msg)); } }
    </script>
</body>
</html>
